<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Listy Wozów — czarno-biały</title>
<meta name="description" content="Listy Wozów, skrytki i sprzęt. Supabase Auth + dane." />
<style>
  :root{ --bg:#fff; --fg:#000; --muted:#444; --line:#000; --gap:16px; --radius:8px; --red:#c00; --green:#0a0; --comp-width:420px; }
  *{ box-sizing:border-box; } html,body{ height:100%; }
  body{ margin:0; background:#fff; color:#000; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  a{ color:inherit; text-decoration:underline; text-underline-offset:2px; }

  .wrap{ width:min(1080px,96vw); margin-inline:auto; }

  header{ border-bottom:1px solid var(--line); background:#fff; position:sticky; top:0; z-index:10; }
  .nav{ display:flex; align-items:center; gap:var(--gap); padding:12px 0; }
  .nav ul{ margin-left:0; display:flex; gap:12px; list-style:none; padding:0; flex-wrap:wrap; }
  .nav a{ text-decoration:none; padding:8px 10px; border-radius:6px; font-weight:700; }
  .nav a:hover{ background:#f2f2f2; }
  .authbox{ margin-left:auto; display:flex; align-items:center; gap:8px; }
  .user-badge{ border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-weight:700; }

  .banner{ position:fixed; left:50%; transform:translateX(-50%); top:8px; z-index:9999;
    padding:10px 14px; border:1px solid var(--line); border-radius:8px; background:#fff; box-shadow:0 2px 0 #000; font-weight:700; }
  .banner.ok{ color:var(--green); border-color:var(--green); }
  .banner.err{ color:var(--red); border-color:var(--red); }

  section{ padding:48px 0; } h1,h2,h3{ line-height:1.2; margin:0 0 .5rem; }
  .sub{ color:var(--muted); margin:.25rem 0 1rem; }
  .card{ border:1px solid var(--line); border-radius:var(--radius); padding:16px; background:#fff; position:relative; }

  .btn{
    appearance:none; background:#fff; color:#000; border:1px solid var(--line);
    padding:10px 12px; border-radius:6px; cursor:pointer;
    box-shadow:0 2px 0 #000; font-weight:700; min-height:44px;
    touch-action: manipulation;
  }
  .btn:hover{ background:#f6f6f6; }
  .btn.primary{ background:#000; color:#fff; }
  .btn.primary:hover{ background:#111; }
  .btn.block{ width:100%; }
  .btn:active{ transform:translateY(1px); box-shadow:0 1px 0 #000; }

  .form-grid{ display:grid; gap:10px; }
  .field{ display:grid; gap:6px; }
  .field label{ font-weight:700; }
  .input{
    border:1px solid var(--line); border-radius:6px; padding:10px 12px; background:#fff; color:#000; font:inherit;
    box-shadow:0 2px 0 #000;
  }
  .row-2{ display:grid; gap:10px; grid-template-columns:1fr 1fr; }
  @media (max-width:900px){ .row-2{ grid-template-columns:1fr; } }
  .error{ color:var(--red); font-weight:700; min-height:1.2em; }
  .okline{ color:var(--green); font-weight:700; min-height:1.2em; }

  /* Fleet */
  .fleet-top{ display:flex; justify-content:center; }
  .fleet-buttons{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
  @media (max-width:640px){ .fleet-buttons .btn{ flex: 1 1 calc(50% - 8px); } }
  @media (max-width:420px){ .fleet-buttons .btn{ flex: 1 1 100%; } }

  .actions-wrap{ display:none; justify-content:center; margin-top:12px; }
  .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }

  /* STAŁY kontener skrytek pod przyciskami i akcjami */
  .compartments-wrap{
    display:flex;
    justify-content:center;
    margin-top:16px;
  }
  .compartments{
    display:flex;
    flex-direction:column;
    gap:8px;
    width:clamp(320px, 92vw, var(--comp-width));
    max-width:100%;
  }
  .compartment-item{ width:100%; }
  .btn.compartment-btn{ width:100%; text-align:center; }

  /* Slot sprzętu — tuż po skrytce */
  .equip-slot{ display:block; width:100%; margin-top:8px; }

  .equip-row{
    display:grid; grid-template-columns:1fr auto; gap:10px;
    padding:10px 12px; border:1px solid var(--line); border-radius:6px; cursor:pointer;
  }
  .equip-row + .equip-row{ margin-top:8px; }
  .equip-name{ font-weight:700; }
  .qty-badge{ border:1px solid var(--line); border-radius:999px; padding:4px 10px; }
  .equip-row.selected{ color:var(--red); border-color:var(--red); }
  .equip-row.selected .qty-badge{ border-color:var(--red); }

  .skeleton{ position:relative; overflow:hidden; background:#fafafa; border:1px solid var(--line); border-radius:6px; }
  .skeleton::after{ content:""; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(0,0,0,.05),transparent); animation:shimmer 1s infinite; }
  @keyframes shimmer{ 0%{ transform:translateX(-100%);} 100%{ transform:translateX(100%);} }

  /* HOME */
  .today-card{ border:1px solid var(--line); border-radius:8px; padding:16px; background:#fff; box-shadow:0 2px 0 #000; }
  .today-card h3{ margin:0 0 6px; font-size:1.1rem; }
  .today-card .tasks{ white-space:pre-wrap; }

  /* BRAKI + Sprzęt JRG — tabele responsywne */
  #shortagesTable, #equipResultsTable{
    width: 100%;
    border-collapse: collapse;
    border: 1px solid var(--line);
  }
  #shortagesTable th, #shortagesTable td,
  #equipResultsTable th, #equipResultsTable td{
    border: 1px solid var(--line);
    padding: 8px 10px;
    text-align: center;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
  }
  #shortagesTable thead th, #equipResultsTable thead th{
    background: #f4f4f4;
    font-weight: 700;
    position: sticky; top: 0; z-index: 1;
  }
  #shortagesTable tbody tr:nth-child(even),
  #equipResultsTable tbody tr:nth-child(een){
    background-color: #f9f9f9;
  }
  @media (max-width: 560px){
    #shortagesTable thead, #equipResultsTable thead{ display:none; }
    #shortagesTable, #equipResultsTable{ border:0; }
    #shortagesTable tbody tr, #equipResultsTable tbody tr{
      display:block; border:1px solid var(--line); border-radius:8px; padding:8px; margin-bottom:10px; background:#fff;
    }
    #shortagesTable tbody tr:nth-child(even), #equipResultsTable tbody tr:nth-child(even){ background:#fff; }
    #shortagesTable td, #equipResultsTable td{
      display:grid; grid-template-columns: 44% 56%; gap:6px 10px; border:0; padding:6px 0; text-align:left; white-space:normal;
    }
    #shortagesTable td::before, #equipResultsTable td::before{ content: attr(data-label); font-weight:700; }
  }

  footer{ border-top:1px solid var(--line); padding:20px 0 40px; color:#222; }
  .hidden{ display:none !important; }
  :focus-visible{ outline: 3px solid #000; outline-offset: 2px; }
  @media (hover:none){ .nav a:hover, .btn:hover{ background:#fff; } }
  @media (prefers-reduced-motion: reduce){ *{ animation:none !important; transition:none !important; } }

.user-dropdown {
  position: relative;
  display: inline-block;
}
.user-badge {
  cursor: pointer;
}
.user-menu {
  position: absolute;
  top: 100%;
  right: 0;
  background: #fff;
  border: 1px solid var(--line);
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-top: 6px;
  z-index: 999;
}
.user-menu.hidden {
  display: none;
}

.auth-center {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 75vh;
}

.auth-card {
  max-width: 400px;
  width: 100%;
  background: white;
  padding: 24px;
  border-radius: 10px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}

.auth-logo {
  text-align: center;
  margin-bottom: 20px;
}
.auth-logo img {
  max-width: 120px;
  height: auto;
}

/* Gdy #compWrap zostanie wstawiony do .fleet-buttons,
   niech zajmie pełną szerokość wiersza przycisków */
.fleet-buttons > #compWrap {
  flex: 1 1 100%;
  margin-top: 8px;
}

/* Na mobile upewnij się, że może mieć 100% szerokości */
@media (max-width: 640px){
  #compWrap { width: 100%; }
}

/* (opcjonalnie) usuń wyśrodkowanie wewnątrz #compWrap na mobile,
   aby lista wyglądała naturalnie pod przyciskiem */
@media (max-width: 640px){
  #compWrap.compartments-wrap { justify-content: stretch; }
}


</style>
</head>
<body>
  <div id="banner" class="banner hidden"></div>

<header>
  <div class="wrap nav" role="navigation">
    <!-- MENU dla niezalogowanych -->
    <ul id="menuAuth">
      <li><a href="#auth">Logowanie</a></li>
    </ul>

    <!-- MENU po zalogowaniu -->
    <ul id="menuApp" class="hidden">
      <li><a href="#home" data-nav>Home</a></li>
      <li><a href="#fleet" data-nav>Listy Wozów</a></li>
      <li><a href="#equip" data-nav>Sprzęt JRG</a></li>
      <li><a href="#knowledge" data-nav>Wiedza</a></li>
      <li><a href="#shortages" data-nav id="menuShortagesLink">Braki</a></li>
    </ul>

    <div class="authbox" id="authBox"></div>
  </div>
</header>

<main id="top">
  <!-- HOME -->
  <section class="hero" id="home">
    <div class="wrap">
      <h1>Home</h1>
      <div id="todayBox" aria-live="polite"></div>
      <div class="cta" style="margin-top:12px;">
        
      </div>
    </div>
  </section>

  <!-- AUTH -->
<section id="auth">
  <div class="wrap">
    <div class="card" id="authCard">

      <!-- LOGIN FORM -->
      <div id="loginBox" class="auth-center">
        <div class="auth-card">
          <div class="auth-logo">
            <img src="logo.png" alt="Logo" />
          </div>
          <h2>Logowanie</h2>
          <div class="form-grid">
            <div class="field">
              <label for="loginPhone">Telefon</label>
              <input id="loginPhone" class="input" type="tel" inputmode="tel" placeholder="+48 123456789" />
            </div>
            <div class="field">
              <label for="loginPass">Hasło</label>
              <input id="loginPass" class="input" type="password" autocomplete="current-password" />
            </div>
            <div class="error" id="loginError" aria-live="polite"></div>
            <button type="button" class="btn primary block" id="loginBtn">Zaloguj</button>
            <div style="text-align:center; margin-top:8px;">
              <button type="button" id="goToRegisterBtn" class="btn" style="font-size:14px;">lub Zarejestruj</button>
            </div>
          </div>
        </div>
      </div>

      <!-- REGISTER FORM (ukryty na start) -->
      <div id="registerBox" class="auth-center hidden">
        <div class="auth-card">
          <div class="auth-logo">
            <img src="logo.png" alt="Logo" />
          </div>
          <h2>Rejestracja</h2>
          <div class="form-grid">
            <div class="field">
              <label for="regPhone">Telefon</label>
              <input id="regPhone" class="input" type="tel" inputmode="tel" placeholder="+48 668 529 988" />
            </div>
            <div class="field">
              <label for="regShift">Zmiana</label>
              <select id="regShift" class="input">
                <option value="">Wybierz zmianę</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="Biuro">Biuro</option>
              </select>
            </div>
            <div class="field">
              <label for="regPass">Hasło</label>
              <input id="regPass" class="input" type="password" autocomplete="new-password" />
            </div>
            <div class="field">
              <label for="regPass2">Potwierdź hasło</label>
              <input id="regPass2" class="input" type="password" autocomplete="new-password" />
            </div>
            <div class="error" id="regError" aria-live="polite"></div>
            <div class="okline" id="regOk" aria-live="polite" style="display:none"></div>
            <button type="button" class="btn primary block" id="registerBtn">Zarejestruj</button>
            <div style="text-align:center; margin-top:8px;">
              <button type="button" id="goToLoginBtn" class="btn" style="font-size:14px;">lub Zaloguj</button>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /card -->
  </div><!-- /wrap -->
</section>


  <!-- FLEET -->
  <section id="fleet" class="hidden">
    <div class="wrap">
      <div class="card" id="fleetCard">
        <!-- Przyciski wozów ZAWSZE NA GÓRZE -->
        <div class="fleet-top">
          <div id="fleetButtons" class="fleet-buttons">
            <button class="btn" data-vehicle="411-22">411-22</button>
            <button class="btn" data-vehicle="411-23">411-23</button>
            <button class="btn" data-vehicle="411-25">411-25</button>
            <button class="btn" data-vehicle="411-26">411-26</button>
            <button class="btn" data-vehicle="411-43">411-43</button>
            <button class="btn" data-vehicle="411-51">411-51</button>
            <button class="btn" data-vehicle="411-71">411-71</button>
            <button class="btn" data-vehicle="411-91">411-91</button>
            <button class="btn" data-vehicle="411-59">411-59</button>
            <button class="btn" data-vehicle="411-22 Tył">411-22 Tył</button>
            <button class="btn" data-vehicle="411-23 Tył">411-23 Tył</button>
          </div>
        </div>

        <!-- Akcje -->
        <div class="actions-wrap" id="actionsWrap">
          <div class="actions">
            <button class="btn" id="expandAllBtn" disabled>Rozwiń wszystkie</button>
            <button class="btn primary" id="sendShortagesBtn" disabled>Wyślij Braki</button>
          </div>
        </div>

        <!-- STAŁA lista skrytek POD przyciskami i akcjami -->
        <div class="compartments-wrap" id="compWrap" style="display:none">
          <div id="compartments" class="compartments"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Sprzęt JRG -->
  <section id="equip" class="hidden">
    <div class="wrap">
      <div class="card">
        <h2>Sprzęt JRG — wyszukiwarka</h2>
        <div class="form-grid" style="grid-template-columns:1fr auto; align-items:end;">
          <div class="field">
            <label for="equipQuery">Szukaj sprzętu</label>
            <input id="equipQuery" class="input" type="text" placeholder="np. defibrylator, nożyce" />
          </div>
          <div><button id="equipSearchBtn" class="btn primary">Szukaj</button></div>
        </div>
        <div style="margin-top:8px" class="sub" id="equipInfo">Wpisz nazwę sprzętu i kliknij „Szukaj”.</div>
        <div>
          <table id="equipResultsTable" aria-label="Wyniki wyszukiwania sprzętu">
            <thead><tr><th>SPRZĘT</th><th>WÓZ</th><th>SKRYTKA</th><th>ILOŚĆ</th></tr></thead>
            <tbody id="equipResultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Wiedza -->
  <section id="knowledge" class="hidden">
    <div class="wrap"><div class="card"><h2>Wiedza</h2><p class="sub">Materiały szkoleniowe, procedury, „ściągi”.</p></div></div>
  </section>

  <!-- BRAKI -->
  <section id="shortages" class="hidden">
    <div class="wrap">
      <div class="card">
        <h2>Braki</h2>
        <p class="sub">Podgląd zgłoszonych braków z bazy.</p>

        <div class="filters" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:10px;">
          <div class="field"><label for="fltDateFrom">Data od</label><input id="fltDateFrom" class="input" type="date" /></div>
          <div class="field"><label for="fltDateTo">Data do</label><input id="fltDateTo" class="input" type="date" /></div>
          <div class="field"><label for="fltVehicle">Wóz</label><input id="fltVehicle" class="input" type="text" placeholder="np. 411-22" /></div>
          <div class="field"><label for="fltUser">Użytkownik</label><input id="fltUser" class="input" type="text" placeholder="Imię i nazwisko" /></div>
          <div class="field" style="align-self:end;"><button id="btnSearch" class="btn primary">Szukaj</button></div>
        </div>

        <div style="margin-top:12px;"><span id="rowsInfo" class="sub"></span></div>

        <div style="margin-top:12px;">
          <table id="shortagesTable" aria-label="Tabela braków">
            <thead><tr><th>SPRZĘT</th><th>WÓZ</th><th>DATA</th><th>ZMIANA</th><th>UŻYTKOWNIK</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="tfoot" style="display:flex; gap:10px; justify-content:space-between; align-items:center; margin-top:10px;">
          <div><button id="btnPrev" class="btn">« Poprzednia</button> <button id="btnNext" class="btn">Następna »</button></div>
          <div class="sub" id="pageInfo">Strona 1</div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="wrap" style="display:flex; justify-content:flex-end; align-items:center; gap:10px; flex-wrap:wrap">
    <a class="btn" href="#top" aria-label="Do góry">Do góry</a>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>
<script>
  // ===== Helpers =====
  const $  = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
  const setBtnLoading  = (btn, on, idle, loading) => { btn.disabled = on; btn.textContent = on ? loading : idle; };
  const showBanner = (text, type='ok', ms=3000) => { const b=$('#banner'); b.textContent=text; b.className=`banner ${type}`; b.classList.remove('hidden'); clearTimeout(showBanner._t); showBanner._t=setTimeout(()=>b.classList.add('hidden'),ms); };
  const formatDate = (v) => { if(!v) return ''; const d=new Date(v.replace(' ','T')); const yyyy=d.getFullYear(),mm=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0'); const hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0'); return `${yyyy}-${mm}-${dd} ${hh}:${mi}`; };
  function vehicleToTableName(vehicle){ let t=vehicle.replace(/\s+/g,'_').replaceAll('-','_'); const map={'ł':'l','Ł':'L','ą':'a','Ą':'A','ć':'c','Ć':'C','ę':'e','Ę':'E','ń':'n','Ń':'N','ó':'o','Ó':'O','ś':'s','Ś':'S','ź':'z','Ź':'Z','ż':'z','Ż':'Z'}; t=t.replace(/./g,ch=>map[ch]||ch); return t; }
  function tableToVehicleName(table){ let v=table.replaceAll('_',' '); v=v.replace(/^(\d{3}) (\d{2})/,(_,a,b)=>`${a}-${b}`); v=v.replace(/Tyl\b/,'Tył'); return v; }

  // ===== Supabase =====
  const SUPABASE_URL = 'https://edihhrnejcdfashksssj.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkaWhocm5lamNkZmFzaGtzc3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MzcyMzEsImV4cCI6MjA2OTMxMzIzMX0.ci5U5kcutKCKVePCu-S-CmsxKm7pup6Bjbralj1aF9Y';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession:false, autoRefreshToken:true, storageKey:'wozy-auth' } });

  // ===== Sekcje/Menu =====
  const menuAuth=$('#menuAuth'), menuApp=$('#menuApp'), authBox=$('#authBox');
  const sectionHome=$('#home'), sectionAuth=$('#auth'), sectionFleet=$('#fleet'), sectionEquip=$('#equip'), sectionKnowledge=$('#knowledge'), sectionShort=$('#shortages');
  const sections=[sectionHome,sectionAuth,sectionFleet,sectionEquip,sectionKnowledge,sectionShort];
  let lastSectionId=localStorage.getItem('lastSectionId')||'#home';
  function showOnly(section){ sections.forEach(s=>s.classList.add('hidden')); section.classList.remove('hidden'); lastSectionId='#'+section.id; try{localStorage.setItem('lastSectionId',lastSectionId);}catch(_){} window.scrollTo({top:0,behavior:'smooth'}); }

// --- Guard "Wstecz" -> pytanie o wylogowanie ---
let backGuardEnabled = false;

function onBackGuard(){
  if(!backGuardEnabled) return;
  const ok = confirm('Czy na pewno chcesz się WYLOGOWAĆ?');
  if(ok){
    window.performLogout?.();
  }else{
    // odtwarzamy wpis w historii, by kolejny "Wstecz" znów trafił tutaj
    history.pushState({guard:'back-logout'}, '');
  }
}

function enableBackLogoutGuard(){
  if(backGuardEnabled) return;
  backGuardEnabled = true;
  history.pushState({guard:'back-logout'}, '');  // dodaj bufor do historii
  window.addEventListener('popstate', onBackGuard);
}

function disableBackLogoutGuard(){
  if(!backGuardEnabled) return;
  backGuardEnabled = false;
  window.removeEventListener('popstate', onBackGuard);
}


  async function isViewer(userId){ if(!userId) return false; const { data } = await supabase.from('shortages_viewers').select('user_id').eq('user_id',userId).maybeSingle(); return !!data; }
  async function refreshAuthUI(session){
    try{
      if(session?.user){
        menuAuth.classList.add('hidden'); menuApp.classList.remove('hidden');
        // pobranie imienia i nazwiska z profilu
let fullName = session.user.email;
try {
  const { data: prof } = await supabase
    .from('profiles')
    .select('full_name')
    .eq('user_id', session.user.id)
    .maybeSingle();
  if (prof?.full_name) fullName = prof.full_name;
} catch(e) { /* jeśli nie znajdzie, zostaje email */ }

// wyświetlenie imienia/nazwiska
authBox.innerHTML = `
  <div class="user-dropdown">
    <button class="user-badge" id="userBadgeBtn" type="button">${fullName}</button>
    <div class="user-menu hidden" id="userMenu">
      <button type="button" class="btn block" id="logoutBtn">Wyloguj</button>
    </div>
  </div>
`;

const userBadgeBtn = document.getElementById('userBadgeBtn');
const userMenu = document.getElementById('userMenu');

// Przełącz widoczność menu po kliknięciu w nazwę użytkownika
userBadgeBtn?.addEventListener('click', (e) => {
  e.preventDefault();
  userMenu.classList.toggle('hidden');
});

// Ukryj menu po kliknięciu gdziekolwiek poza nim
// Podpinamy TYLKO raz
if (!window._menuOutsideClickAttached) {
  document.addEventListener('click', (e) => {
    const box  = document.getElementById('authBox');   // zawsze bierz aktualny węzeł
    const menu = document.getElementById('userMenu');  // i aktualne menu (może nie istnieć)
    if (!box || !menu) return;                         // gdy niezalogowany – nic nie rób
    if (!box.contains(e.target)) {
      menu.classList.add('hidden');
    }
  });
  window._menuOutsideClickAttached = true;
}

// globalna wersja – dostępna wszędzie
window.performLogout = async function(){
  try{
    await supabase.auth.signOut();
    showBanner('Wylogowano.','ok');
  }catch(err){
    showBanner('Błąd wylogowania','err',4000);
  } finally{
    showOnly(sectionAuth);
    authBox.innerHTML='';
    menuApp.classList.add('hidden');
    menuAuth.classList.remove('hidden');
    try{ localStorage.removeItem('lastSectionId'); }catch(_){}
    disableBackLogoutGuard();
  }
};



       $('#logoutBtn')?.addEventListener('click', async (e)=>{
  e.preventDefault();
  await window.performLogout();
});


        const target=sections.find(s=> '#'+s.id===lastSectionId )||sectionHome; showOnly(target); if(target===sectionHome) loadTodayTask(); enableBackLogoutGuard();

      } else {
        authBox.innerHTML=''; menuApp.classList.add('hidden'); menuAuth.classList.remove('hidden'); showOnly(sectionAuth); disableBackLogoutGuard();

      }
    }catch(e){}
  }
  supabase.auth.onAuthStateChange((_e,session)=>refreshAuthUI(session));
  supabase.auth.getSession().then(({data})=>refreshAuthUI(data.session));

  // ===== Rejestracja/Logowanie (+ auto +48) =====
  const loginPhone=$('#loginPhone'), loginPass=$('#loginPass'), loginBtn=$('#loginBtn'), loginErr=$('#loginError');
  const regPhone=$('#regPhone'), regShift=$('#regShift'), regPass=$('#regPass'), regPass2=$('#regPass2'), regBtn=$('#registerBtn'), regErr=$('#regError'), regOk=$('#regOk');

  function formatPhoneInput(input){ if(!input) return; let val=(input.value||'').trim().replace(/\s+/g,''); if(!val) return; if(val.startsWith('+48')){ input.value=val; return;} if(/^48\d+$/.test(val)){ input.value='+'+val; return;} if(/^\d/.test(val)){ input.value='+48'+val; return;} }
  loginPhone?.addEventListener('blur',()=>formatPhoneInput(loginPhone));
  regPhone?.addEventListener('blur',()=>formatPhoneInput(regPhone));

  regBtn?.addEventListener('click', async ()=>{
    formatPhoneInput(regPhone); regErr.textContent=''; regOk.style.display='none';
    const digits=(regPhone.value||'').replace(/\D/g,''), shift=regShift.value, pass=regPass.value, pass2=regPass2.value;
    if(!digits){ regErr.textContent='Podaj numer telefonu.'; return; }
    if(!shift){ regErr.textContent='Wybierz zmianę.'; return; }
    if(!pass || pass.length<6){ regErr.textContent='Hasło min. 6 znaków.'; return; }
    if(pass!==pass2){ regErr.textContent='Hasła nie są takie same.'; return; }
    const email=`${digits}@phones.local`;
    setBtnLoading(regBtn,true,'Zarejestruj','Rejestracja...');
    try{
      const { error } = await supabase.auth.signUp({ email, password:pass, options:{ data:{ phone_digits:digits, shift } } });
      if(error){ regErr.textContent = `(${error.status||'??'}) ${error.message}`; showBanner('Rejestracja nieudana: '+(error.message||''),'err',5000); return; }
      regOk.textContent='Konto zostało utworzone, możesz się zalogować.'; regOk.style.display='block'; showBanner('Konto utworzone. Zaloguj się.','ok',4000);
    }catch(e){ regErr.textContent=e?.message||String(e); showBanner('Błąd krytyczny rejestracji','err',5000);
    }finally{ setBtnLoading(regBtn,false,'Zarejestruj','Rejestracja...'); }
  });

  loginBtn?.addEventListener('click', async ()=>{
    formatPhoneInput(loginPhone); loginErr.textContent='';
    const digits=(loginPhone.value||'').replace(/\D/g,''), pass=loginPass.value;
    if(!digits){ loginErr.textContent='Podaj numer telefonu.'; return; }
    if(!pass){ loginErr.textContent='Podaj hasło.'; return; }
    const email=`${digits}@phones.local`;
    setBtnLoading(loginBtn,true,'Zaloguj','Logowanie...');
    try{
      const { error } = await supabase.auth.signInWithPassword({ email, password:pass });
      if(error){ loginErr.textContent=`(${error.status||'??'}) ${error.message}`; showBanner('Błąd logowania: '+(error.message||''),'err',5000); return; }
      showBanner('Zalogowano.','ok',2500); showOnly(sectionHome); try{ localStorage.setItem('lastSectionId','#home'); }catch(_){}
      loadTodayTask();
    }catch(e){ loginErr.textContent=e?.message||String(e); showBanner('Błąd krytyczny logowania','err',5000);
    }finally{ setBtnLoading(loginBtn,false,'Zaloguj','Logowanie...'); }
  });
  const loginBox = document.getElementById('loginBox');
const registerBox = document.getElementById('registerBox');
const goToRegisterBtn = document.getElementById('goToRegisterBtn');
const goToLoginBtn = document.getElementById('goToLoginBtn');

goToRegisterBtn?.addEventListener('click', () => {
  loginBox.classList.add('hidden');
  registerBox.classList.remove('hidden');
});

goToLoginBtn?.addEventListener('click', () => {
  registerBox.classList.add('hidden');
  loginBox.classList.remove('hidden');
});


  // ====== FLEET (przyciski u góry, stały kontener skrytek pod nimi) ======
  const fleetButtons=$('#fleetButtons'), actionsWrap=$('#actionsWrap');
  const compartmentsOuter=document.getElementById('compWrap'); // stały, pod akcjami
  // zapamiętaj oryginalnego rodzica, żeby na desktopie odkładać panel na miejsce
const compOriginalParent = compartmentsOuter.parentElement;

// narzędzie do ustawiania #compWrap we właściwym miejscu
function placeCompWrap() {
  const activeBtn = document.querySelector('#fleetButtons .btn.primary');
  if (window.matchMedia('(max-width: 640px)').matches && activeBtn) {
    // mobile: wsadź panel zaraz za aktywny przycisk
    activeBtn.insertAdjacentElement('afterend', compartmentsOuter);
  } else {
    // desktop: odłóż pod akcje (tak jak było)
    compOriginalParent.appendChild(compartmentsOuter);
  }
}
function closeVehiclePanel(){
  // schowaj panel + akcje
  compartmentsOuter.style.display = 'none';
  actionsWrap.style.display = 'none';

  // wyczyść UI i stan
  compartmentsBox.innerHTML = '';
  compartmentsOuter.dataset.openFor = '';
  currentVehicle = null;
  currentTable = null;

  // reset przycisków
  $$('#fleetButtons .btn').forEach(b => b.classList.remove('primary'));
  if (collapseAllBtn) { collapseAllBtn.remove(); collapseAllBtn = null; }
  expandAllBtn.disabled = true;
  sendShortagesBtn.disabled = true;
}
  const compartmentsBox=$('#compartments');
  const expandAllBtn=$('#expandAllBtn'), sendShortagesBtn=$('#sendShortagesBtn');
  let collapseAllBtn=null;

  let currentVehicle=null, currentTable=null;
  const selectedSet=new Set(); const keyFor=(t,c,id)=>`${t}|${c}|${id}`;

  async function fetchCompartmentsInTableOrder(table){
    const { data, error } = await supabase.from(table).select('id, compartment').not('compartment','is',null).order('id',{ascending:true});
    if(error) throw error;
    const seen=new Set(), list=[]; for(const r of data||[]){ const c=r.compartment; if(c && !seen.has(c)){ seen.add(c); list.push({name:c}); } }
    return list;
  }
  async function fetchEquip(table, compartment){
    const { data, error } = await supabase.from(table).select('id, "SPRZĘT", "ILOŚĆ", compartment').eq('compartment',compartment).order('id',{ascending:true});
    if(error) throw error; return data||[];
  }

  function showLoadingCompartments(){
    compartmentsOuter.style.display=''; compartmentsBox.style.display=''; compartmentsBox.innerHTML='';
    for(let i=0;i<5;i++){ const s=document.createElement('div'); s.className='skeleton'; s.style.height='42px'; s.style.border='1px solid #000'; s.style.borderRadius='6px'; s.style.marginTop=i?'8px':'0'; compartmentsBox.appendChild(s); }
  }
  function renderCompartments(list){
    compartmentsBox.innerHTML=''; compartmentsBox.style.display='';
    if(!list.length){ compartmentsBox.innerHTML='<div class="sub">Brak skrytek.</div>'; return; }
    list.forEach(({name})=>{
      const wrap=document.createElement('div'); wrap.className='compartment-item';
      const btn=document.createElement('button'); btn.className='btn compartment-btn'; btn.textContent=name; btn.setAttribute('data-compartment',name);
      const slot=document.createElement('div'); slot.className='equip-slot'; slot.setAttribute('data-equip-slot',name); slot.dataset.open='false';
      wrap.append(btn,slot); compartmentsBox.appendChild(wrap);
    });
    actionsWrap.style.display='flex'; expandAllBtn.disabled=false; sendShortagesBtn.disabled=false;
  }

  function showLoadingEquipInSlot(slot){ slot.innerHTML=''; for(let i=0;i<4;i++){ const r=document.createElement('div'); r.className='skeleton'; r.style.height='44px'; r.style.marginTop='8px'; slot.appendChild(r); } }
  function renderEquipInSlot(slot, rows, table, compartment){
    slot.innerHTML=''; if(!rows.length){ slot.innerHTML='<div class="sub">Brak sprzętu w tej skrytce.</div>'; return; }
    rows.forEach(r=>{
      const row=document.createElement('div'); row.className='equip-row'; row.dataset.id=String(r.id); row.dataset.compartment=compartment;
      if(selectedSet.has(keyFor(table,compartment,r.id))) row.classList.add('selected');
      row.innerHTML=`<div class="equip-name">${r['SPRZĘT']}</div><div class="qty-badge">${r['ILOŚĆ']}</div>`;
      slot.appendChild(row);
    });
  }

  async function openCompartment(btn){
    const slot=btn.nextElementSibling; if(!slot) return;
    // akordeon tylko w obrębie tego kontenera
    $$('#compartments .equip-slot').forEach(s=>{ if(s!==slot){ s.dataset.open='false'; s.innerHTML=''; } });
    $$('#compartments .compartment-btn').forEach(b=>{ if(b!==btn){ b.classList.remove('primary'); } });

    if(slot.dataset.open==='true'){ slot.dataset.open='false'; slot.innerHTML=''; btn.classList.remove('primary'); return; }

    btn.classList.add('primary'); slot.dataset.open='true'; showLoadingEquipInSlot(slot);
    try{
      const rows=await fetchEquip(currentTable, btn.getAttribute('data-compartment'));
      renderEquipInSlot(slot, rows, currentTable, btn.getAttribute('data-compartment'));
    }catch(err){ slot.innerHTML=`<div class="sub">Błąd pobierania sprzętu: ${err.message||err}</div>`; }
  }

  // Klik w wóz → pokaż skrytki w STAŁYM kontenerze pod przyciskami
  fleetButtons?.addEventListener('click', async (e)=>{
  const btn = e.target.closest('[data-vehicle]');
  if(!btn) return;

  const vehicle = btn.getAttribute('data-vehicle');
  const table   = vehicleToTableName(vehicle);

  // TOGGLE: jeśli klikamy ponownie w ten sam wóz -> zamknij i wyjdź
  if (compartmentsOuter.dataset.openFor === table && compartmentsOuter.style.display !== 'none') {
    closeVehiclePanel();
    return;
  }

  // Otwieramy/zmieniamy wóz
  $$('#fleetButtons .btn').forEach(b => b.classList.remove('primary'));
  btn.classList.add('primary');

  currentVehicle = vehicle;
  currentTable   = table;

  // ustaw panel (mobile: pod przyciskiem, desktop: pod akcjami)
  placeCompWrap();

  // pokaż panel i przygotuj UI
  compartmentsOuter.style.display = '';   // w HTML startowo masz display:none
  actionsWrap.style.display = 'flex';
  expandAllBtn.disabled = true;
  sendShortagesBtn.disabled = true;
  compartmentsBox.innerHTML = '';
  compartmentsOuter.dataset.openFor = table; // zapamiętaj otwarty wóz

  // skeletony + pobranie skrytek
  showLoadingCompartments();
  try{
    const list = await fetchCompartmentsInTableOrder(currentTable);
    renderCompartments(list);
  }catch(err){
    compartmentsBox.innerHTML = `<div class="sub">Błąd pobierania skrytek: ${err.message||err}</div>`;
  }
});


  // Klik w skrytkę / sprzęt (delegacja na stałym kontenerze)
  compartmentsBox?.addEventListener('click', (e)=>{
    const btn=e.target.closest('.compartment-btn'); if(btn) return openCompartment(btn);
    const row=e.target.closest('.equip-row'); if(!row) return;
    const k=keyFor(currentTable,row.dataset.compartment,row.dataset.id);
    row.classList.toggle('selected'); if(row.classList.contains('selected')) selectedSet.add(k); else selectedSet.delete(k);
  });

  // Rozwiń wszystkie (dla bieżącego wozu) + „Zwiń wszystkie” na dole
  expandAllBtn?.addEventListener('click', async ()=>{
    if(!currentTable) return;
    const items=$$('#compartments .compartment-item');
    await Promise.all(items.map(async item=>{
      const b=item.querySelector('.compartment-btn'); const s=item.querySelector('.equip-slot');
      if(s.dataset.open==='true' && s.children.length) return;
      b.classList.add('primary'); s.dataset.open='true'; showLoadingEquipInSlot(s);
      try{ const rows=await fetchEquip(currentTable, b.getAttribute('data-compartment')); renderEquipInSlot(s, rows, currentTable, b.getAttribute('data-compartment')); }
      catch(err){ s.innerHTML=`<div class="sub">Błąd pobierania sprzętu: ${err.message||err}</div>`; }
    }));
    if(!collapseAllBtn){
      collapseAllBtn=document.createElement('button'); collapseAllBtn.className='btn'; collapseAllBtn.textContent='Zwiń wszystkie'; collapseAllBtn.style.marginTop='12px'; collapseAllBtn.style.width='100%';
      collapseAllBtn.addEventListener('click',()=>{ $$('#compartments .equip-slot').forEach(s=>{ s.dataset.open='false'; s.innerHTML=''; }); $$('#compartments .compartment-btn').forEach(b=>b.classList.remove('primary')); collapseAllBtn.remove(); collapseAllBtn=null; });
      compartmentsBox.appendChild(collapseAllBtn);
    }
  });

  // Wyślij Braki — tylko bieżący wóz
  document.getElementById('sendShortagesBtn')?.addEventListener('click', async ()=>{
    if(!currentVehicle || !currentTable) return;
    const selectedKeys=[...selectedSet].filter(k=>k.startsWith(currentTable+'|')); if(!selectedKeys.length){ alert('Nie wybrano żadnych braków.'); return; }
    const ids=[...new Set(selectedKeys.map(k=>Number(k.split('|')[2])).filter(Number.isFinite))];
    let equipById=new Map();
    try{ const { data, error } = await supabase.from(currentTable).select('id, "SPRZĘT"').in('id',ids); if(error) throw error; (data||[]).forEach(r=>equipById.set(Number(r.id),(r['SPRZĘT']??'').toString())); }
    catch(err){ showBanner('Błąd pobierania danych sprzętu.','err',4000); return; }

    const { data: udata } = await supabase.auth.getUser(); const userId=udata?.user?.id||null;
    let shift=null, fullName=null; try{ const { data: prof } = await supabase.from('profiles').select('shift, full_name').eq('user_id',userId).maybeSingle(); shift=prof?.shift||null; fullName=prof?.full_name||null; }catch(e){}
    const rows=ids.map(id=>({ 'SPRZĘT':equipById.get(id)||`ID ${id}`, 'WÓZ':currentVehicle, 'ZMIANA':shift, 'UŻYTKOWNIK':fullName, user_id:userId }));
    try{ const { error } = await supabase.from('shortages').insert(rows); if(error) throw error;
      showBanner(`Wysłano braki: ${rows.length} wiersz(y).`,'ok',4000);
      for(const k of [...selectedSet]) if(k.startsWith(currentTable+'|')) selectedSet.delete(k);
      $$('#compartments .equip-row.selected').forEach(r=>r.classList.remove('selected'));
    }catch(err){ showBanner('Błąd zapisu braków.','err',5000); }
  });

  /* ========= EKRAN BRAKI ========= */
  const fltDateFrom=$('#fltDateFrom'), fltDateTo=$('#fltDateTo'), fltVehicle=$('#fltVehicle'), fltUser=$('#fltUser');
  const btnSearch=$('#btnSearch'), tableBody=$('#shortagesTable tbody'), rowsInfo=$('#rowsInfo'), pageInfo=$('#pageInfo'), btnPrev=$('#btnPrev'), btnNext=$('#btnNext');
  let page=1; const pageSize=25; let lastRows=[];
  function buildQuery(){ let q=supabase.from('shortages').select('"SPRZĘT","WÓZ","DATA","ZMIANA","UŻYTKOWNIK"',{count:'exact'}).order('DATA',{ascending:false});
    if(fltDateFrom.value){ q=q.gte('DATA',fltDateFrom.value+' 00:00'); } if(fltDateTo.value){ q=q.lte('DATA',fltDateTo.value+' 23:59'); }
    if(fltVehicle.value){ q=q.ilike('"WÓZ"',`%${fltVehicle.value}%`); } if(fltUser.value){ q=q.ilike('"UŻYTKOWNIK"',`%${fltUser.value}%`); }
    return q.range((page-1)*pageSize, page*pageSize-1);
  }
  async function loadShortages(){
    if(!document.body.contains(tableBody)) return;
    tableBody.innerHTML='<tr><td colspan="5">Ładowanie…</td></tr>';
    try{ const { data, count, error } = await buildQuery(); if(error) throw error; lastRows=data||[]; renderShortagesTable(lastRows); rowsInfo.textContent=`Wyników: ${count ?? lastRows.length}`; pageInfo.textContent=`Strona ${page}`; btnPrev.disabled=page<=1; btnNext.disabled=(count ?? lastRows.length) <= page*pageSize; }
    catch(e){ tableBody.innerHTML='<tr><td colspan="5">Błąd pobierania.</td></tr>'; }
  }
  function renderShortagesTable(rows){
    if(!rows.length){ tableBody.innerHTML='<tr><td colspan="5">Brak danych.</td></tr>'; return; }
    tableBody.innerHTML=''; rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td data-label="SPRZĘT">${(r['SPRZĘT']||'').toString()}</td>
      <td data-label="WÓZ">${(r['WÓZ']||'').toString()}</td><td data-label="DATA">${formatDate(r['DATA'])}</td>
      <td data-label="ZMIANA">${(r['ZMIANA']||'').toString()}</td><td data-label="UŻYTKOWNIK">${(r['UŻYTKOWNIK']||'').toString()}</td>`; tableBody.appendChild(tr); });
  }
  btnSearch?.addEventListener('click',()=>{ page=1; loadShortages(); });
  btnPrev?.addEventListener('click',()=>{ if(page>1){ page--; loadShortages(); } });
  btnNext?.addEventListener('click',()=>{ page++; loadShortages(); });

  // ====== MENU ======
  document.querySelector('a[href="#home"][data-nav]')?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(sectionHome); loadTodayTask(); });
  document.querySelector('a[href="#fleet"][data-nav]')?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(sectionFleet); });
  document.querySelector('a[href="#equip"][data-nav]')?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(sectionEquip); });
  document.querySelector('a[href="#knowledge"][data-nav]')?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(sectionKnowledge); });
  document.querySelector('#menuShortagesLink[data-nav]')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const { data: me } = await supabase.auth.getUser();
    const canSee = await isViewer(me?.user?.id);
    if(!canSee){ showBanner('Brak uprawnień do podglądu braków.','err',3500); return; }
    if(!$('#fltDateFrom').value && !$('#fltDateTo').value){ const d=new Date(); const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0'); $('#fltDateFrom').value=`${y}-${m}-${dd}`; $('#fltDateTo').value=`${y}-${m}-${dd}`; }
    showOnly(sectionShort); page=1; loadShortages();
  });

  // ===== HOME: dzisiejsze zadanie (Europe/Warsaw) =====
  const todayBox=document.getElementById('todayBox');
  function getWarsawDow(){ const now=new Date(); const warsaw=new Date(now.toLocaleString('en-US',{timeZone:'Europe/Warsaw'})); const day=warsaw.getDay(); return day===0?7:day; }
  async function loadTodayTask(){
    if(!todayBox) return; todayBox.innerHTML='<div class="skeleton" style="height:92px"></div>';
    const dow=getWarsawDow();
    try{ const { data, error } = await supabase.from('weekly_tasks').select('dow, day_name, tasks').eq('dow',dow).maybeSingle(); if(error) throw error; renderToday(data); }
    catch(e){ todayBox.innerHTML='<div class="sub">Błąd pobierania zadania na dziś.</div>'; }
  }
  function renderToday(row){ const name=row?.day_name||'Dziś'; const tasks=(row?.tasks||'').toString(); todayBox.innerHTML=`<div class="today-card"><h3>${name} — dziś</h3><div class="tasks">${tasks||'Brak zadania na dziś.'}</div></div>`; }
  (function scheduleMidnightRefresh(){ const now=new Date(); const warsawNow=new Date(now.toLocaleString('en-US',{timeZone:'Europe/Warsaw'})); const midnight=new Date(warsawNow); midnight.setHours(24,0,0,0); const ms=midnight-warsawNow; setTimeout(()=>{ loadTodayTask(); scheduleMidnightRefresh(); }, Math.max(1000,ms)); })();

  /* ===== Sprzęt JRG — wyszukiwarka ===== */
  const equipQueryInput=$('#equipQuery'), equipSearchBtn=$('#equipSearchBtn'), equipInfo=$('#equipInfo'), equipResultsBody=$('#equipResultsBody');
  const EQUIP_TABLES=['411_22','411_23','411_25','411_26','411_43','411_51','411_71','411_91','411_59','411_22_Tyl','411_23_Tyl'];
  async function searchEquipmentGlobal(term){
    const q=term.trim(); if(!q){ equipInfo.textContent='Wpisz nazwę sprzętu i kliknij „Szukaj”.'; equipResultsBody.innerHTML=''; return; }
    equipInfo.textContent='Szukam…'; equipResultsBody.innerHTML='<tr><td colspan="4">Ładowanie…</td></tr>';
    const results=[]; await Promise.all(EQUIP_TABLES.map(async tbl=>{ const { data, error } = await supabase.from(tbl).select('compartment, "SPRZĘT","ILOŚĆ"').ilike('"SPRZĘT"', `%${q}%`); if(!error && data&&data.length){ data.forEach(r=>results.push({ item:(r['SPRZĘT']||'').toString(), vehicle:tableToVehicleName(tbl), compartment:(r.compartment||'').toString(), qty:(r['ILOŚĆ']||'').toString() })); } }));
    results.sort((a,b)=> (a.vehicle.localeCompare(b.vehicle)||a.compartment.localeCompare(b.compartment)||a.item.localeCompare(b.item)));
    if(!results.length){ equipInfo.textContent='Brak wyników.'; equipResultsBody.innerHTML='<tr><td colspan="4">Brak wyników.</td></tr>'; return; }
    equipInfo.textContent=`Znaleziono: ${results.length}`;
    equipResultsBody.innerHTML=results.map(r=>`<tr><td data-label="SPRZĘT">${r.item}</td><td data-label="WÓZ">${r.vehicle}</td><td data-label="SKRYTKA">${r.compartment}</td><td data-label="ILOŚĆ">${r.qty}</td></tr>`).join('');
  }
  equipSearchBtn?.addEventListener('click',()=>searchEquipmentGlobal(equipQueryInput.value));
  equipQueryInput?.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); searchEquipmentGlobal(equipQueryInput.value); } });
</script>
</body>
</html>


