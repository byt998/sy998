<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Listy WozÃ³w â€” czarno-biaÅ‚y</title>
<meta name="description" content="Listy WozÃ³w, skrytki i sprzÄ™t. Supabase Auth + dane." />
<style>
  :root{ --bg:#fff; --fg:#000; --muted:#444; --line:#000; --gap:16px; --radius:8px; --red:#c00; --green:#0a0; --comp-width:420px; }
  *{ box-sizing:border-box; } html,body{ height:100%; }
  body{ margin:0; background:#fff; color:#000; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  a{ color:inherit; text-decoration:underline; text-underline-offset:2px; }

  .wrap{ width:min(1080px,96vw); margin-inline:auto; }

  header{ border-bottom:1px solid var(--line); background:#fff; position:sticky; top:0; z-index:10; }
  .nav{ display:flex; align-items:center; gap:var(--gap); padding:12px 0; }
  .nav ul{ margin-left:0; display:flex; gap:12px; list-style:none; padding:0; flex-wrap:wrap; }
  .nav a{ text-decoration:none; padding:8px 10px; border-radius:6px; font-weight:700; }
  .nav a:hover{ background:#f2f2f2; }
  .authbox{ margin-left:auto; display:flex; align-items:center; gap:8px; }
  .user-badge{ border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-weight:700; }

  .banner{ position:fixed; left:50%; transform:translateX(-50%); top:8px; z-index:9999;
    padding:10px 14px; border:1px solid var(--line); border-radius:8px; background:#fff; box-shadow:0 2px 0 #000; font-weight:700; }
  .banner.ok{ color:var(--green); border-color:var(--green); }
  .banner.err{ color:var(--red); border-color:var(--red); }

  section{ padding:48px 0; } h1,h2,h3{ line-height:1.2; margin:0 0 .5rem; }
  .sub{ color:var(--muted); margin:.25rem 0 1rem; }
  .card{ border:1px solid var(--line); border-radius:var(--radius); padding:16px; background:#fff; position:relative; }

  .btn{
    appearance:none; background:#fff; color:#000; border:1px solid var(--line);
    padding:10px 12px; border-radius:6px; cursor:pointer;
    box-shadow:0 2px 0 #000; font-weight:700; min-height:44px;
    touch-action: manipulation;
  }
  .btn:hover{ background:#f6f6f6; }
  .btn.primary{ background:#000; color:#fff; }
  .btn.primary:hover{ background:#111; }
  .btn.block{ width:100%; }
  .btn:active{ transform:translateY(1px); box-shadow:0 1px 0 #000; }

  .form-grid{ display:grid; gap:10px; }
  .field{ display:grid; gap:6px; }
  .field label{ font-weight:700; }
  .input{
    border:1px solid var(--line); border-radius:6px; padding:10px 12px; background:#fff; color:#000; font:inherit;
    box-shadow:0 2px 0 #000;
  }
  .row-2{ display:grid; gap:10px; grid-template-columns:1fr 1fr; }
  @media (max-width:900px){ .row-2{ grid-template-columns:1fr; } }
  .error{ color:var(--red); font-weight:700; min-height:1.2em; }
  .okline{ color:var(--green); font-weight:700; min-height:1.2em; }

  /* Fleet */
  .fleet-top{ display:flex; justify-content:center; }
  .fleet-buttons{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
  @media (max-width:640px){ .fleet-buttons .btn{ flex: 1 1 calc(50% - 8px); } }
  @media (max-width:420px){ .fleet-buttons .btn{ flex: 1 1 100%; } }

  .actions-wrap{ display:none; justify-content:center; margin-top:12px; }
  .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }

  /* STAÅY kontener skrytek pod przyciskami i akcjami */
  .compartments-wrap{
    display:flex;
    justify-content:center;
    margin-top:16px;
  }
  .compartments{
    display:flex;
    flex-direction:column;
    gap:8px;
    width:clamp(320px, 92vw, var(--comp-width));
    max-width:100%;
  }
  .compartment-item{ width:100%; }
  .btn.compartment-btn{ width:100%; text-align:center; }

  /* Slot sprzÄ™tu â€” tuÅ¼ po skrytce */
  .equip-slot{ display:block; width:100%; margin-top:8px; }

  .equip-row{
    display:grid; grid-template-columns:1fr auto; gap:10px;
    padding:10px 12px; border:1px solid var(--line); border-radius:6px; cursor:pointer;
  }
  .equip-row + .equip-row{ margin-top:8px; }
  .equip-name{ font-weight:700; }
  .qty-badge{ border:1px solid var(--line); border-radius:999px; padding:4px 10px; }
  .equip-row.selected{ color:var(--red); border-color:var(--red); }
  .equip-row.selected .qty-badge{ border-color:var(--red); }

  .skeleton{ position:relative; overflow:hidden; background:#fafafa; border:1px solid var(--line); border-radius:6px; }
  .skeleton::after{ content:""; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(0,0,0,.05),transparent); animation:shimmer 1s infinite; }
  @keyframes shimmer{ 0%{ transform:translateX(-100%);} 100%{ transform:translateX(100%);} }

  /* HOME */
  .today-card{ border:1px solid var(--line); border-radius:8px; padding:16px; background:#fff; box-shadow:0 2px 0 #000; }
  .today-card h3{ margin:0 0 6px; font-size:1.1rem; }
  .today-card .tasks{ white-space:pre-wrap; }

  /* BRAKI + SprzÄ™t JRG â€” tabele responsywne */
  #shortagesTable, #equipResultsTable{
    width: 100%;
    border-collapse: collapse;
    border: 1px solid var(--line);
  }
  #shortagesTable th, #shortagesTable td,
  #equipResultsTable th, #equipResultsTable td{
    border: 1px solid var(--line);
    padding: 8px 10px;
    text-align: center;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
  }
  #shortagesTable thead th, #equipResultsTable thead th{
    background: #f4f4f4;
    font-weight: 700;
    position: sticky; top: 0; z-index: 1;
  }
  #shortagesTable tbody tr:nth-child(even),
  #equipResultsTable tbody tr:nth-child(een){
    background-color: #f9f9f9;
  }
  @media (max-width: 560px){
    #shortagesTable thead, #equipResultsTable thead{ display:none; }
    #shortagesTable, #equipResultsTable{ border:0; }
    #shortagesTable tbody tr, #equipResultsTable tbody tr{
      display:block; border:1px solid var(--line); border-radius:8px; padding:8px; margin-bottom:10px; background:#fff;
    }
    #shortagesTable tbody tr:nth-child(even), #equipResultsTable tbody tr:nth-child(even){ background:#fff; }
    #shortagesTable td, #equipResultsTable td{
      display:grid; grid-template-columns: 44% 56%; gap:6px 10px; border:0; padding:6px 0; text-align:left; white-space:normal;
    }
    #shortagesTable td::before, #equipResultsTable td::before{ content: attr(data-label); font-weight:700; }
  }

  footer{ border-top:1px solid var(--line); padding:20px 0 40px; color:#222; }
  .hidden{ display:none !important; }
  :focus-visible{ outline: 3px solid #000; outline-offset: 2px; }
  @media (hover:none){ .nav a:hover, .btn:hover{ background:#fff; } }
  @media (prefers-reduced-motion: reduce){ *{ animation:none !important; transition:none !important; } }

.user-dropdown {
  position: relative;
  display: inline-block;
}
.user-badge {
  cursor: pointer;
}
.user-menu {
  position: absolute;
  top: 100%;
  right: 0;
  background: #fff;
  border: 1px solid var(--line);
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-top: 6px;
  z-index: 999;
}
.user-menu.hidden {
  display: none;
}

.auth-center {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 75vh;
}

.auth-card {
  max-width: 400px;
  width: 100%;
  background: white;
  padding: 24px;
  border-radius: 10px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}

.auth-logo {
  text-align: center;
  margin-bottom: 20px;
}
.auth-logo img {
  max-width: 120px;
  height: auto;
}

/* Gdy #compWrap zostanie wstawiony do .fleet-buttons,
   niech zajmie peÅ‚nÄ… szerokoÅ›Ä‡ wiersza przyciskÃ³w */
.fleet-buttons > #compWrap {
  flex: 1 1 100%;
  margin-top: 8px;
}

/* Na mobile upewnij siÄ™, Å¼e moÅ¼e mieÄ‡ 100% szerokoÅ›ci */
@media (max-width: 640px){
  #compWrap { width: 100%; }
}

/* (opcjonalnie) usuÅ„ wyÅ›rodkowanie wewnÄ…trz #compWrap na mobile,
   aby lista wyglÄ…daÅ‚a naturalnie pod przyciskiem */
@media (max-width: 640px){
  #compWrap.compartments-wrap { justify-content: stretch; }
}

.quiz-btn.correct {
  background-color: #4CAF50 !important;
  color: white;
}

.quiz-btn.incorrect {
  background-color: #F44336 !important;
  color: white;
}

.quiz-btn.disabled {
  pointer-events: none;
  opacity: 0.6;
}

#ranking-container table {
  width: 100%;
  border-collapse: collapse;
}

#ranking-container th, #ranking-container td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

#ranking-container th {
  background-color: #f2f2f2;
}

#ritTableContainer table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background-color: white;
  border: 2px solid black;
  border-radius: 12px;
  box-shadow: 6px 6px 0px black; /* GRUBY czarny cieÅ„ */
  margin-top: 10px;
  overflow: hidden;
  font-family: Arial, sans-serif;
}

#ritTableContainer th, #ritTableContainer td {
  padding: 12px;
  text-align: center;
  font-weight: bold;
  border-bottom: 1px solid #ccc;
}

#ritTableContainer th {
  background-color: #f0f0f0;
  font-size: 16px;
}

#ritTableContainer tr:nth-child(even) td {
  background-color: #f9f9f9; /* Szary co drugi wiersz */
}

#ritTableContainer tr:last-child td {
  border-bottom: none;
}




#helpSection .container {
  max-width: 800px;
  width: 100%;
  margin: 0 auto;
}

#helpSection h1, #helpSection h2 {
  text-align: center;
  margin-bottom: 20px;
}

#helpSection h1 {
  font-size: 24px;
}

#helpSection h2 {
  font-size: 18px;
  font-weight: normal;
}

#helpSection .card {
  background: #fff;
  border: 2px solid #000;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 4px 4px 0px #000;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  opacity: 0;
  transform: translateY(20px);
  animation: slideUp 0.5s ease forwards;
}

#helpSection .card:hover {
  transform: scale(1.02);
  box-shadow: 6px 6px 0px #000;
}

#helpSection .card h3 {
  font-size: 18px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

#helpSection ul {
  list-style: none;
  padding-left: 0;
}

#helpSection li {
  font-size: 15px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

#helpSection .centered-list {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

#helpSection .centered-list li {
  justify-content: center;
  text-align: center;
  font-size: 16px;
  margin-bottom: 0;
}

#helpSection .arrow {
  font-size: 22px;
  color: #000;
  animation: bounce 1.2s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(5px); }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }

}

.card-style-button {
  background-color: white;
  color: black;
  border: 1px solid black;
  border-radius: 12px;
  padding: 10px 24px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 3px 4px rgb(0, 0, 0);
  transition: background-color 0.3s ease;
}

#helpSectionAlt .container {
  max-width: 800px;
  width: 100%;
  margin: 0 auto;
}

#helpSectionAlt h1, #helpSectionAlt h2 {
  text-align: center;
  margin-bottom: 20px;
}

#helpSectionAlt .card {
  background: #fff;
  border: 2px solid #000;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 4px 4px 0px #000;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  opacity: 0;
  transform: translateY(20px);
  animation: slideUp 0.5s ease forwards;
}

#helpSectionAlt .card:hover {
  transform: scale(1.02);
  box-shadow: 6px 6px 0px #000;
}

#helpSectionAlt .card h3 {
    font-size: 18px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

#helpSectionAlt ul {
  list-style: none;
  padding-left: 0;
}

#helpSectionAlt li {
  font-size: 15px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

#helpSectionAlt .centered-list {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

#helpSectionAlt .centered-list li {
  justify-content: center;
  text-align: center;
  font-size: 16px;
  margin-bottom: 0;
}

#helpSectionAlt .arrow {
  font-size: 24px;
  color: black;
  animation: bounce 1.2s infinite;
}

  @keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(5px); }

  }

  @keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }

}


.device-button {
  background-color: white;
  color: black;
  font-weight: bold;
  border: 2px solid black;
  border-radius: 12px;
  padding: 10px 20px;
  font-size: 16px;
  box-shadow: 4px 4px 0px black;
  cursor: pointer;
  margin: 10px 0;
  display: block;
  width: 100%;
  max-width: 300px;
}

.device-button:hover {
  transform: scale(1.02);
  box-shadow: 6px 6px 0px black;
}

#deviceSectionContainer table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background-color: white;
  border: 2px solid black;
  border-radius: 12px;
  box-shadow: 6px 6px 0px black;
  margin-top: 10px;
  font-family: Arial, sans-serif;
}

#deviceSectionContainer th, #deviceSectionContainer td {
  padding: 12px;
  text-align: center;
  font-weight: bold;
  border-bottom: 1px solid #ccc;
}

#deviceSectionContainer tr:nth-child(even) td {
  background-color: #f9f9f9;
}



</style>
</head>
<body>
  <div id="banner" class="banner hidden"></div>

<header>
  <div class="wrap nav" role="navigation">
    <!-- MENU dla niezalogowanych -->
    <ul id="menuAuth">
      <li><a href="#auth">Logowanie</a></li>
    </ul>

    <!-- MENU po zalogowaniu -->
    <ul id="menuApp" class="hidden">
      <li><a href="#home" data-nav>Home</a></li>
      <li><a href="#fleet" data-nav>Listy WozÃ³w</a></li>
      <li><a href="#equip" data-nav>SprzÄ™t JRG</a></li>
      <li><a href="#knowledge" data-nav>Wiedza</a></li>
      <li><a href="#shortages" data-nav id="menuShortagesLink">Braki</a></li>
    </ul>

    <div class="authbox" id="authBox"></div>
  </div>
</header>

<main id="top">
  <!-- HOME -->
  <section class="hero" id="home">
    <div class="wrap">
      <h1>Home</h1>
      <div id="todayBox" aria-live="polite"></div>
      <div class="cta" style="margin-top:12px;">
        
      </div>
    </div>
  </section>

  <!-- AUTH -->
<section id="auth">
  <div class="wrap">
    <div class="card" id="authCard">

      <!-- LOGIN FORM -->
      <div id="loginBox" class="auth-center">
        <div class="auth-card">
          <div class="auth-logo">
            <img src="logo.png" alt="Logo" />
          </div>
          <h2>Logowanie</h2>
          <div class="form-grid">
            <div class="field">
              <label for="loginPhone">Telefon</label>
              <input id="loginPhone" class="input" type="tel" inputmode="tel" placeholder="+48 123456789" />
            </div>
            <div class="field">
              <label for="loginPass">HasÅ‚o</label>
              <input id="loginPass" class="input" type="password" autocomplete="current-password" />
            </div>
            <div class="error" id="loginError" aria-live="polite"></div>
            <button type="button" class="btn primary block" id="loginBtn">Zaloguj</button>
            <div style="text-align:center; margin-top:8px;">
              <button type="button" id="goToRegisterBtn" class="btn" style="font-size:14px;">lub Zarejestruj</button>
            </div>
          </div>
        </div>
      </div>

      <!-- REGISTER FORM (ukryty na start) -->
      <div id="registerBox" class="auth-center hidden">
        <div class="auth-card">
          <div class="auth-logo">
            <img src="logo.png" alt="Logo" />
          </div>
          <h2>Rejestracja</h2>
          <div class="form-grid">
            <div class="field">
              <label for="regPhone">Telefon</label>
              <input id="regPhone" class="input" type="tel" inputmode="tel" placeholder="+48 668 529 988" />
            </div>
            <div class="field">
              <label for="regShift">Zmiana</label>
              <select id="regShift" class="input">
                <option value="">Wybierz zmianÄ™</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="Biuro">Biuro</option>
              </select>
            </div>
            <div class="field">
              <label for="regPass">HasÅ‚o</label>
              <input id="regPass" class="input" type="password" autocomplete="new-password" />
            </div>
            <div class="field">
              <label for="regPass2">PotwierdÅº hasÅ‚o</label>
              <input id="regPass2" class="input" type="password" autocomplete="new-password" />
            </div>
            <div class="error" id="regError" aria-live="polite"></div>
            <div class="okline" id="regOk" aria-live="polite" style="display:none"></div>
            <button type="button" class="btn primary block" id="registerBtn">Zarejestruj</button>
            <div style="text-align:center; margin-top:8px;">
              <button type="button" id="goToLoginBtn" class="btn" style="font-size:14px;">lub Zaloguj</button>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /card -->
  </div><!-- /wrap -->
</section>


  <!-- FLEET -->
  <section id="fleet" class="hidden">
    <div class="wrap">
      <div class="card" id="fleetCard">
        <!-- Przyciski wozÃ³w ZAWSZE NA GÃ“RZE -->
        <div class="fleet-top">
          <div id="fleetButtons" class="fleet-buttons">
            <button class="btn" data-vehicle="411-22">411-22</button>
            <button class="btn" data-vehicle="411-23">411-23</button>
            <button class="btn" data-vehicle="411-25">411-25</button>
            <button class="btn" data-vehicle="411-26">411-26</button>
            <button class="btn" data-vehicle="411-43">411-43</button>
            <button class="btn" data-vehicle="411-51">411-51</button>
            <button class="btn" data-vehicle="411-71">411-71</button>
            <button class="btn" data-vehicle="411-91">411-91</button>
            <button class="btn" data-vehicle="411-59">411-59</button>
            <button class="btn" data-vehicle="411-22 TyÅ‚">411-22 TyÅ‚</button>
            <button class="btn" data-vehicle="411-23 TyÅ‚">411-23 TyÅ‚</button>
          </div>
        </div>

        <!-- Akcje -->
        <div class="actions-wrap" id="actionsWrap">
          <div class="actions">
            <button class="btn" id="expandAllBtn" disabled>RozwiÅ„ wszystkie</button>
            <button class="btn primary" id="sendShortagesBtn" disabled>WyÅ›lij Braki</button>
          </div>
        </div>

        <!-- STAÅA lista skrytek POD przyciskami i akcjami -->
        <div class="compartments-wrap" id="compWrap" style="display:none">
          <div id="compartments" class="compartments"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- SprzÄ™t JRG -->
  <section id="equip" class="hidden">
    <div class="wrap">
      <div class="card">
        <h2>SprzÄ™t JRG â€” wyszukiwarka</h2>
        <div class="form-grid" style="grid-template-columns:1fr auto; align-items:end;">
          <div class="field">
            <label for="equipQuery">Szukaj sprzÄ™tu</label>
            <input id="equipQuery" class="input" type="text" placeholder="np. defibrylator, noÅ¼yce" />
          </div>
          <div><button id="equipSearchBtn" class="btn primary">Szukaj</button></div>
        </div>
        <div style="margin-top:8px" class="sub" id="equipInfo">Wpisz nazwÄ™ sprzÄ™tu i kliknij â€Szukajâ€.</div>
        <div>
          <table id="equipResultsTable" aria-label="Wyniki wyszukiwania sprzÄ™tu">
            <thead><tr><th>SPRZÄ˜T</th><th>WÃ“Z</th><th>SKRYTKA</th><th>ILOÅšÄ†</th></tr></thead>
            <tbody id="equipResultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Wiedza -->
  <section id="knowledge" class="hidden">
  <div class="wrap">
    <div class="card">
      <h2>Wiedza</h2>
      <p class="sub">MateriaÅ‚y szkoleniowe, procedury, â€Å›ciÄ…giâ€.</p>
    
      <div id="knowledge-buttons" style="display: block;">
  <div style="margin-bottom: 10px;">
    <button class="btn primary" id="startQuizBtn" style="display: block; width: 100%; margin-bottom: 10px;">Quiz tygodniowy</button>
    <button class="btn primary" id="ritBtn" style="display: block; width: 100%; margin-bottom: 10px;">RIT</button>
    
</div>

   <div id="ritSection" style="display: none; margin-top: 16px;">
  <!-- KONTENER PRZYCISKÃ“W -->
<div style="display: flex; flex-direction: column; align-items: center; gap: 16px; margin-bottom: 16px;">

  <!-- PRZYCISK TORBA RIT -->
  <div style="display: flex; flex-direction: column; align-items: center;">
   <button id="toggleRitTable" class="card-style-button">TORBA RIT</button>

    <!-- TABELA POD PRZYCISKIEM -->
    <div id="ritTableContainer" style="display: none; margin-top: 10px; width: 100%; max-width: 600px;">
      <!-- Tabela zostanie zaÅ‚adowana dynamicznie -->
    </div>
  </div>

  <!-- PRZYCISK WEZWANIE POMOCY -->
<button id="helpRequestBtn" class="card-style-button">Wezwanie Pomocy</button>
<div id="helpSection" style="display: none; margin-top: 20px;">
  <!-- Tutaj wkleisz zawartoÅ›Ä‡ z GRAFIKA.html -->
     <div class="container">
    <h1>ZaÅ‚Ä…cznik nr 2</h1>
    <h2>Wezwanie pomocy przez straÅ¼aka (sprawny aparat OUO)</h2>

    <!-- Karty -->
    <div class="card">
      <h3>1ï¸âƒ£ Sytuacja wymagajÄ…ca wezwania pomocy</h3>
    </div>

    <div class="card">
      <h3>2ï¸âƒ£ Wezwanie pomocy przez zagroÅ¼onego straÅ¼aka:</h3>
      <ul class="centered-list">
        <li>ğŸš¨ â€Ratunek, Ratunek, Ratunekâ€</li>
        <div class="arrow">â¬‡</div>
        <li>ğŸ“ Gdzie?</li>
        <div class="arrow">â¬‡</div>
        <li>â“ Co?</li>
        <div class="arrow">â¬‡</div>
        <li>ğŸ§‘â€ğŸš’ Kto?</li>
      </ul>
    </div>

    <div class="card">
      <h3>3ï¸âƒ£ Uzyskanie potwierdzenia</h3>
      <ul>
        <li>ğŸ”„ W przypadku braku potwierdzenia kontynuowaÄ‡ dalszÄ… procedurÄ™</li>
        <li>ğŸ“ Systematycznie, co jakiÅ› czas wzywaÄ‡ pomoc</li>
      </ul>
    </div>

    <div class="card">
      <h3>4ï¸âƒ£ Aktywowanie sygnalizatora bezruchu</h3>
    </div>

    <div class="card">
      <h3>5ï¸âƒ£ PrÃ³by ewakuacji (samoratowanie)</h3>
      <p>JeÅ¼eli nie ma szans na ewakuacjÄ™ â€“ minimalizowaÄ‡ wysiÅ‚ek</p>
    </div>

    <div class="card">
      <h3>6ï¸âƒ£ Utrzymywanie Å‚Ä…cznoÅ›ci z RIT</h3>
      <p>JeÅ¼eli jest Å‚Ä…cznoÅ›Ä‡</p>
    </div>

    <div class="card">
      <h3>7ï¸âƒ£ OdwoÅ‚anie wezwania o pomoc</h3>
      <p>W przypadku udanego samoratowania</p>
    </div>
  </div>
</div>
<button id="helpRequestBtnAlt" class="card-style-button">Wezwanie Pomocy â€“ Awaria OUO</button>
<div id="helpSectionAlt" style="display: none; margin-top: 20px;">
 <div class="container">
    <h1>ZaÅ‚Ä…cznik nr 3</h1>
    <h2>Wezwanie pomocy przez straÅ¼aka w przypadku awarii aparatu OUO</h2>

    <div class="card">
      <h3>1ï¸âƒ£ Sytuacja wymagajÄ…ca wezwania pomocy zwiÄ…zana z awariÄ… aparatu OUO</h3>
    </div>

    <div class="card">
      <h3>2ï¸âƒ£ PoÅ‚oÅ¼yÄ‡ siÄ™ na podÅ‚odze</h3>
    </div>

    <div class="card">
      <h3>3ï¸âƒ£ AktywowaÄ‡ alarm sygnalizatora bezruchu</h3>
    </div>

    <div class="card">
      <h3>4ï¸âƒ£ SprawdziÄ‡ automat oddechowy</h3>
    </div>

    <div class="card">
      <h3>5ï¸âƒ£ OdÅ‚Ä…czyÄ‡ automat oddechowy</h3>
    </div>

    <div class="card">
      <h3>6ï¸âƒ£ NaÅ‚oÅ¼yÄ‡ kominiarkÄ™ na otwÃ³r, rÄ™kawica â€“ opcjonalnie</h3>
    </div>

    <div class="card">
      <h3>7ï¸âƒ£ WezwaÄ‡ pomoc drogÄ… radiowÄ… (przykryÄ‡ sygnalizator dÅ‚oniÄ…):</h3>
      <ul class="centered-list">
        <li>ğŸš¨ â€Ratunek, Ratunek, Ratunekâ€</li>
        <div class="arrow">â¬‡</div>
        <li>ğŸ“ Gdzie?</li>
        <div class="arrow">â¬‡</div>
        <li>â“ Co?</li>
        <div class="arrow">â¬‡</div>
        <li>ğŸ§‘â€ğŸš’ Kto?</li>
      </ul>
    </div>

    <div class="card">
      <h3>8ï¸âƒ£ UzyskaÄ‡ potwierdzenie</h3>
      <ul>
        <li>ğŸ”„ W przypadku braku potwierdzenia kontynuowaÄ‡ dalszÄ… procedurÄ™</li>
        <li>ğŸ“ Systematycznie, co jakiÅ› czas wzywaÄ‡ pomoc</li>
      </ul>
    </div>

    <div class="card">
      <h3>9ï¸âƒ£ PodjÄ…Ä‡ prÃ³by opuszczenia strefy zagroÅ¼enia</h3>
    </div>

    <div class="card">
      <h3>ğŸ”Ÿ OdwoÅ‚aÄ‡ wezwanie o pomoc w przypadku udanego samoratowania</h3>
    </div>
  </div>
</div>

</div>




  <div id="ritTableContainer" style="display: none;"></div>



</div>
 <button class="btn primary" id="pomiaroweBtn" style="display: block; width: 100%;">PrzyrzÄ…dy pomiarowe</button>

<div id="toolsSection" style="display: none; margin: 10px;">
  <div class="container">
    <h2>PrzyrzÄ…dy pomiarowe</h2>
    <div style="display: flex; justify-content: center;">
  <div id="deviceButtonsContainer" style="display: flex; flex-direction: column; align-items: center;"></div>
</div>
<div id="deviceSectionContainer"></div>
    <div style="display: flex; flex-direction: column; align-items: center; gap: 16px; margin-bottom: 16px;">
    
  </div>

    </div>
  </div>
 
</section>

<section id="quiz" class="hidden">
  <div class="wrap">
    <div class="card">
      <h2>Quiz tygodniowy</h2>
      <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
       <button class="btn primary" id="run-weekly-quiz">Rozpocznij Quiz</button>
<div id="quiz-container" style="margin-top: 16px;"></div>
<div id="ranking" style="margin-top: 32px;">
  <div style="margin-bottom: 10px;">
    <button class="btn" onclick="loadRanking('weekly')">Ranking Tygodniowy</button>
    <button class="btn" onclick="loadRanking('monthly')">Ranking MiesiÄ™czny</button>
  </div>
  <div id="ranking-container">
    <p>Wybierz ranking powyÅ¼ej</p>
  </div>
</div>

        <p class="sub" style="margin-top: 12px;">
          W quizie moÅ¼na wziÄ…Ä‡ udziaÅ‚ jeden raz w tygodniu (od PoniedziaÅ‚ku do Niedzieli do godziny 23:59).<br />
          Quiz skÅ‚ada siÄ™ z 10 pytaÅ„. Na odpowiedÅº masz 25 sekund.<br />
          W kaÅ¼dy poniedziaÅ‚ek generuje siÄ™ ranking tygodniowy, a w kaÅ¼dy pierwszy dzieÅ„ miesiÄ…ca zobaczysz ranking miesiÄ™czny.<br />
          Baw siÄ™ dobrze!
        </p>
        <a class="btn" href="#knowledge" data-nav>PowrÃ³t</a>
      </div>
    </div>
  </div>
</section>


  <!-- BRAKI -->
  <section id="shortages" class="hidden">
    <div class="wrap">
      <div class="card">
        <h2>Braki</h2>
        <p class="sub">PodglÄ…d zgÅ‚oszonych brakÃ³w z bazy.</p>

        <div class="filters" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:10px;">
          <div class="field"><label for="fltDateFrom">Data od</label><input id="fltDateFrom" class="input" type="date" /></div>
          <div class="field"><label for="fltDateTo">Data do</label><input id="fltDateTo" class="input" type="date" /></div>
          <div class="field"><label for="fltVehicle">WÃ³z</label><input id="fltVehicle" class="input" type="text" placeholder="np. 411-22" /></div>
          <div class="field"><label for="fltUser">UÅ¼ytkownik</label><input id="fltUser" class="input" type="text" placeholder="ImiÄ™ i nazwisko" /></div>
          <div class="field" style="align-self:end;"><button id="btnSearch" class="btn primary">Szukaj</button></div>
        </div>

        <div style="margin-top:12px;"><span id="rowsInfo" class="sub"></span></div>

        <div style="margin-top:12px;">
          <table id="shortagesTable" aria-label="Tabela brakÃ³w">
            <thead><tr><th>SPRZÄ˜T</th><th>WÃ“Z</th><th>DATA</th><th>ZMIANA</th><th>UÅ»YTKOWNIK</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="tfoot" style="display:flex; gap:10px; justify-content:space-between; align-items:center; margin-top:10px;">
          <div><button id="btnPrev" class="btn">Â« Poprzednia</button> <button id="btnNext" class="btn">NastÄ™pna Â»</button></div>
          <div class="sub" id="pageInfo">Strona 1</div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="wrap" style="display:flex; justify-content:flex-end; align-items:center; gap:10px; flex-wrap:wrap">
    <a class="btn" href="#top" aria-label="Do gÃ³ry">Do gÃ³ry</a>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>
<script>
    
  // ===== Helpers =====
  const $  = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
  const setBtnLoading  = (btn, on, idle, loading) => { btn.disabled = on; btn.textContent = on ? loading : idle; };
  const showBanner = (text, type='ok', ms=3000) => { const b=$('#banner'); b.textContent=text; b.className=`banner ${type}`; b.classList.remove('hidden'); clearTimeout(showBanner._t); showBanner._t=setTimeout(()=>b.classList.add('hidden'),ms); };
  const formatDate = (v) => { if(!v) return ''; const d=new Date(v.replace(' ','T')); const yyyy=d.getFullYear(),mm=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0'); const hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0'); return `${yyyy}-${mm}-${dd} ${hh}:${mi}`; };
  function vehicleToTableName(vehicle){ let t=vehicle.replace(/\s+/g,'_').replaceAll('-','_'); const map={'Å‚':'l','Å':'L','Ä…':'a','Ä„':'A','Ä‡':'c','Ä†':'C','Ä™':'e','Ä˜':'E','Å„':'n','Åƒ':'N','Ã³':'o','Ã“':'O','Å›':'s','Åš':'S','Åº':'z','Å¹':'Z','Å¼':'z','Å»':'Z'}; t=t.replace(/./g,ch=>map[ch]||ch); return t; }
  function tableToVehicleName(table){ let v=table.replaceAll('_',' '); v=v.replace(/^(\d{3}) (\d{2})/,(_,a,b)=>`${a}-${b}`); v=v.replace(/Tyl\b/,'TyÅ‚'); return v; }

  // ===== Supabase =====
  const SUPABASE_URL = 'https://edihhrnejcdfashksssj.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkaWhocm5lamNkZmFzaGtzc3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MzcyMzEsImV4cCI6MjA2OTMxMzIzMX0.ci5U5kcutKCKVePCu-S-CmsxKm7pup6Bjbralj1aF9Y';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession:true, autoRefreshToken:true, storageKey:'wozy-auth' } });

  // ===== Sekcje/Menu =====
  const menuAuth=$('#menuAuth'), menuApp=$('#menuApp'), authBox=$('#authBox');
  const sectionHome=$('#home'), sectionAuth=$('#auth'), sectionFleet=$('#fleet'), sectionEquip=$('#equip'), sectionKnowledge=$('#knowledge'), sectionShort=$('#shortages');
  const sectionQuiz = document.getElementById('quiz');
  const sections = [sectionHome, sectionAuth, sectionFleet, sectionEquip, sectionKnowledge, sectionShort, sectionQuiz];

  let lastSectionId=localStorage.getItem('lastSectionId')||'#home';
  function showOnly(section){ sections.forEach(s=>s.classList.add('hidden')); section.classList.remove('hidden'); lastSectionId='#'+section.id; try{localStorage.setItem('lastSectionId',lastSectionId);}catch(_){} window.scrollTo({top:0,behavior:'smooth'}); }

// --- Guard "Wstecz" -> pytanie o wylogowanie ---
let backGuardEnabled = false;

function onBackGuard(){
  if(!backGuardEnabled) return;
  const ok = confirm('Czy na pewno chcesz siÄ™ WYLOGOWAÄ†?');
  if(ok){
    window.performLogout?.();
  }else{
    // odtwarzamy wpis w historii, by kolejny "Wstecz" znÃ³w trafiÅ‚ tutaj
    history.pushState({guard:'back-logout'}, '');
  }
}

function enableBackLogoutGuard(){
  if(backGuardEnabled) return;
  backGuardEnabled = true;
  history.pushState({guard:'back-logout'}, '');  // dodaj bufor do historii
  window.addEventListener('popstate', onBackGuard);
}

function disableBackLogoutGuard(){
  if(!backGuardEnabled) return;
  backGuardEnabled = false;
  window.removeEventListener('popstate', onBackGuard);
}


  async function isViewer(userId){ if(!userId) return false; const { data } = await supabase.from('shortages_viewers').select('user_id').eq('user_id',userId).maybeSingle(); return !!data; }
  async function refreshAuthUI(session){
    try{
      if(session?.user){
        menuAuth.classList.add('hidden'); menuApp.classList.remove('hidden');
        // pobranie imienia i nazwiska z profilu
let fullName = session.user.email;
try {
  const { data: prof } = await supabase
    .from('profiles')
    .select('full_name')
    .eq('user_id', session.user.id)
    .maybeSingle();
  if (prof?.full_name) fullName = prof.full_name;
} catch(e) { /* jeÅ›li nie znajdzie, zostaje email */ }

// wyÅ›wietlenie imienia/nazwiska
authBox.innerHTML = `
  <div class="user-dropdown">
    <button class="user-badge" id="userBadgeBtn" type="button">${fullName}</button>
    <div class="user-menu hidden" id="userMenu">
      <button type="button" class="btn block" id="logoutBtn">Wyloguj</button>
    </div>
  </div>
`;

const userBadgeBtn = document.getElementById('userBadgeBtn');
const userMenu = document.getElementById('userMenu');

// PrzeÅ‚Ä…cz widocznoÅ›Ä‡ menu po klikniÄ™ciu w nazwÄ™ uÅ¼ytkownika
userBadgeBtn?.addEventListener('click', (e) => {
  e.preventDefault();
  userMenu.classList.toggle('hidden');
});

// Ukryj menu po klikniÄ™ciu gdziekolwiek poza nim
// Podpinamy TYLKO raz
if (!window._menuOutsideClickAttached) {
  document.addEventListener('click', (e) => {
    const box  = document.getElementById('authBox');   // zawsze bierz aktualny wÄ™zeÅ‚
    const menu = document.getElementById('userMenu');  // i aktualne menu (moÅ¼e nie istnieÄ‡)
    if (!box || !menu) return;                         // gdy niezalogowany â€“ nic nie rÃ³b
    if (!box.contains(e.target)) {
      menu.classList.add('hidden');
    }
  });
  window._menuOutsideClickAttached = true;
}

// globalna wersja â€“ dostÄ™pna wszÄ™dzie
window.performLogout = async function(){
  try{
    await supabase.auth.signOut();
    showBanner('Wylogowano.','ok');
  }catch(err){
    showBanner('BÅ‚Ä…d wylogowania','err',4000);
  } finally{
    showOnly(sectionAuth);
    authBox.innerHTML='';
    menuApp.classList.add('hidden');
    menuAuth.classList.remove('hidden');
    try{ localStorage.removeItem('lastSectionId'); }catch(_){}
    disableBackLogoutGuard();
  }
};



       $('#logoutBtn')?.addEventListener('click', async (e)=>{
  e.preventDefault();
  await window.performLogout();
});


        const target=sections.find(s=> '#'+s.id===lastSectionId )||sectionHome; showOnly(target); if(target===sectionHome) loadTodayTask(); enableBackLogoutGuard();

      } else {
        authBox.innerHTML=''; menuApp.classList.add('hidden'); menuAuth.classList.remove('hidden'); showOnly(sectionAuth); disableBackLogoutGuard();

      }
    }catch(e){}
  }
  supabase.auth.onAuthStateChange((_e,session)=>refreshAuthUI(session));
  supabase.auth.getSession().then(({data})=>refreshAuthUI(data.session));

  // ===== Rejestracja/Logowanie (+ auto +48) =====
  const loginPhone=$('#loginPhone'), loginPass=$('#loginPass'), loginBtn=$('#loginBtn'), loginErr=$('#loginError');
  const regPhone=$('#regPhone'), regShift=$('#regShift'), regPass=$('#regPass'), regPass2=$('#regPass2'), regBtn=$('#registerBtn'), regErr=$('#regError'), regOk=$('#regOk');

  function formatPhoneInput(input){ if(!input) return; let val=(input.value||'').trim().replace(/\s+/g,''); if(!val) return; if(val.startsWith('+48')){ input.value=val; return;} if(/^48\d+$/.test(val)){ input.value='+'+val; return;} if(/^\d/.test(val)){ input.value='+48'+val; return;} }
  loginPhone?.addEventListener('blur',()=>formatPhoneInput(loginPhone));
  regPhone?.addEventListener('blur',()=>formatPhoneInput(regPhone));

  regBtn?.addEventListener('click', async ()=>{
    formatPhoneInput(regPhone); regErr.textContent=''; regOk.style.display='none';
    const digits=(regPhone.value||'').replace(/\D/g,''), shift=regShift.value, pass=regPass.value, pass2=regPass2.value;
    if(!digits){ regErr.textContent='Podaj numer telefonu.'; return; }
    if(!shift){ regErr.textContent='Wybierz zmianÄ™.'; return; }
    if(!pass || pass.length<6){ regErr.textContent='HasÅ‚o min. 6 znakÃ³w.'; return; }
    if(pass!==pass2){ regErr.textContent='HasÅ‚a nie sÄ… takie same.'; return; }
    const email=`${digits}@phones.local`;
    setBtnLoading(regBtn,true,'Zarejestruj','Rejestracja...');
    try{
      const { error } = await supabase.auth.signUp({ email, password:pass, options:{ data:{ phone_digits:digits, shift } } });
      if(error){ regErr.textContent = `(${error.status||'??'}) ${error.message}`; showBanner('Rejestracja nieudana: '+(error.message||''),'err',5000); return; }
      regOk.textContent='Konto zostaÅ‚o utworzone, moÅ¼esz siÄ™ zalogowaÄ‡.'; regOk.style.display='block'; showBanner('Konto utworzone. Zaloguj siÄ™.','ok',4000);
    }catch(e){ regErr.textContent=e?.message||String(e); showBanner('BÅ‚Ä…d krytyczny rejestracji','err',5000);
    }finally{ setBtnLoading(regBtn,false,'Zarejestruj','Rejestracja...'); }
  });

  loginBtn?.addEventListener('click', async ()=>{
    formatPhoneInput(loginPhone); loginErr.textContent='';
    const digits=(loginPhone.value||'').replace(/\D/g,''), pass=loginPass.value;
    if(!digits){ loginErr.textContent='Podaj numer telefonu.'; return; }
    if(!pass){ loginErr.textContent='Podaj hasÅ‚o.'; return; }
    const email=`${digits}@phones.local`;
    setBtnLoading(loginBtn,true,'Zaloguj','Logowanie...');
    try{
      const { error } = await supabase.auth.signInWithPassword({ email, password:pass });
      if(error){ loginErr.textContent=`(${error.status||'??'}) ${error.message}`; showBanner('BÅ‚Ä…d logowania: '+(error.message||''),'err',5000); return; }
      showBanner('Zalogowano.','ok',2500); showOnly(sectionHome); try{ localStorage.setItem('lastSectionId','#home'); }catch(_){}
      loadTodayTask();
    }catch(e){ loginErr.textContent=e?.message||String(e); showBanner('BÅ‚Ä…d krytyczny logowania','err',5000);
    }finally{ setBtnLoading(loginBtn,false,'Zaloguj','Logowanie...'); }
  });
  const loginBox = document.getElementById('loginBox');
const registerBox = document.getElementById('registerBox');
const goToRegisterBtn = document.getElementById('goToRegisterBtn');
const goToLoginBtn = document.getElementById('goToLoginBtn');

goToRegisterBtn?.addEventListener('click', () => {
  loginBox.classList.add('hidden');
  registerBox.classList.remove('hidden');
});

goToLoginBtn?.addEventListener('click', () => {
  registerBox.classList.add('hidden');
  loginBox.classList.remove('hidden');
});


  // ====== FLEET (przyciski u gÃ³ry, staÅ‚y kontener skrytek pod nimi) ======
  const fleetButtons=$('#fleetButtons'), actionsWrap=$('#actionsWrap');
  const compartmentsOuter=document.getElementById('compWrap'); // staÅ‚y, pod akcjami
  // zapamiÄ™taj oryginalnego rodzica, Å¼eby na desktopie odkÅ‚adaÄ‡ panel na miejsce
const compOriginalParent = compartmentsOuter.parentElement;

// narzÄ™dzie do ustawiania #compWrap we wÅ‚aÅ›ciwym miejscu
function placeCompWrap() {
  const activeBtn = document.querySelector('#fleetButtons .btn.primary');
  if (window.matchMedia('(max-width: 640px)').matches && activeBtn) {
    // mobile: wsadÅº panel zaraz za aktywny przycisk
    activeBtn.insertAdjacentElement('afterend', compartmentsOuter);
  } else {
    // desktop: odÅ‚Ã³Å¼ pod akcje (tak jak byÅ‚o)
    compOriginalParent.appendChild(compartmentsOuter);
  }
}
function closeVehiclePanel(){
  // schowaj panel + akcje
  compartmentsOuter.style.display = 'none';
  actionsWrap.style.display = 'none';

  // wyczyÅ›Ä‡ UI i stan
  compartmentsBox.innerHTML = '';
  compartmentsOuter.dataset.openFor = '';
  currentVehicle = null;
  currentTable = null;

  // reset przyciskÃ³w
  $$('#fleetButtons .btn').forEach(b => b.classList.remove('primary'));
  if (collapseAllBtn) { collapseAllBtn.remove(); collapseAllBtn = null; }
  expandAllBtn.disabled = true;
  sendShortagesBtn.disabled = true;
}
  const compartmentsBox=$('#compartments');
  const expandAllBtn=$('#expandAllBtn'), sendShortagesBtn=$('#sendShortagesBtn');
  let collapseAllBtn=null;

  let currentVehicle=null, currentTable=null;
  const selectedSet=new Set(); const keyFor=(t,c,id)=>`${t}|${c}|${id}`;

  async function fetchCompartmentsInTableOrder(table){
    const { data, error } = await supabase.from(table).select('id, compartment').not('compartment','is',null).order('id',{ascending:true});
    if(error) throw error;
    const seen=new Set(), list=[]; for(const r of data||[]){ const c=r.compartment; if(c && !seen.has(c)){ seen.add(c); list.push({name:c}); } }
    return list;
  }
  async function fetchEquip(table, compartment){
    const { data, error } = await supabase.from(table).select('id, "SPRZÄ˜T", "ILOÅšÄ†", compartment').eq('compartment',compartment).order('id',{ascending:true});
    if(error) throw error; return data||[];
  }

  function showLoadingCompartments(){
    compartmentsOuter.style.display=''; compartmentsBox.style.display=''; compartmentsBox.innerHTML='';
    for(let i=0;i<5;i++){ const s=document.createElement('div'); s.className='skeleton'; s.style.height='42px'; s.style.border='1px solid #000'; s.style.borderRadius='6px'; s.style.marginTop=i?'8px':'0'; compartmentsBox.appendChild(s); }
  }
  function renderCompartments(list){
    compartmentsBox.innerHTML=''; compartmentsBox.style.display='';
    if(!list.length){ compartmentsBox.innerHTML='<div class="sub">Brak skrytek.</div>'; return; }
    list.forEach(({name})=>{
      const wrap=document.createElement('div'); wrap.className='compartment-item';
      const btn=document.createElement('button'); btn.className='btn compartment-btn'; btn.textContent=name; btn.setAttribute('data-compartment',name);
      const slot=document.createElement('div'); slot.className='equip-slot'; slot.setAttribute('data-equip-slot',name); slot.dataset.open='false';
      wrap.append(btn,slot); compartmentsBox.appendChild(wrap);
    });
    actionsWrap.style.display='flex'; expandAllBtn.disabled=false; sendShortagesBtn.disabled=false;
  }

  function showLoadingEquipInSlot(slot){ slot.innerHTML=''; for(let i=0;i<4;i++){ const r=document.createElement('div'); r.className='skeleton'; r.style.height='44px'; r.style.marginTop='8px'; slot.appendChild(r); } }
  function renderEquipInSlot(slot, rows, table, compartment){
    slot.innerHTML=''; if(!rows.length){ slot.innerHTML='<div class="sub">Brak sprzÄ™tu w tej skrytce.</div>'; return; }
    rows.forEach(r=>{
      const row=document.createElement('div'); row.className='equip-row'; row.dataset.id=String(r.id); row.dataset.compartment=compartment;
      if(selectedSet.has(keyFor(table,compartment,r.id))) row.classList.add('selected');
      row.innerHTML=`<div class="equip-name">${r['SPRZÄ˜T']}</div><div class="qty-badge">${r['ILOÅšÄ†']}</div>`;
      slot.appendChild(row);
    });
  }

  async function openCompartment(btn){
    const slot=btn.nextElementSibling; if(!slot) return;
    // akordeon tylko w obrÄ™bie tego kontenera
    $$('#compartments .equip-slot').forEach(s=>{ if(s!==slot){ s.dataset.open='false'; s.innerHTML=''; } });
    $$('#compartments .compartment-btn').forEach(b=>{ if(b!==btn){ b.classList.remove('primary'); } });

    if(slot.dataset.open==='true'){ slot.dataset.open='false'; slot.innerHTML=''; btn.classList.remove('primary'); return; }

    btn.classList.add('primary'); slot.dataset.open='true'; showLoadingEquipInSlot(slot);
    try{
      const rows=await fetchEquip(currentTable, btn.getAttribute('data-compartment'));
      renderEquipInSlot(slot, rows, currentTable, btn.getAttribute('data-compartment'));
    }catch(err){ slot.innerHTML=`<div class="sub">BÅ‚Ä…d pobierania sprzÄ™tu: ${err.message||err}</div>`; }
  }

  // Klik w wÃ³z â†’ pokaÅ¼ skrytki w STAÅYM kontenerze pod przyciskami
  fleetButtons?.addEventListener('click', async (e)=>{
  const btn = e.target.closest('[data-vehicle]');
  if(!btn) return;

  const vehicle = btn.getAttribute('data-vehicle');
  const table   = vehicleToTableName(vehicle);

  // TOGGLE: jeÅ›li klikamy ponownie w ten sam wÃ³z -> zamknij i wyjdÅº
  if (compartmentsOuter.dataset.openFor === table && compartmentsOuter.style.display !== 'none') {
    closeVehiclePanel();
    return;
  }

  // Otwieramy/zmieniamy wÃ³z
  $$('#fleetButtons .btn').forEach(b => b.classList.remove('primary'));
  btn.classList.add('primary');

  currentVehicle = vehicle;
  currentTable   = table;

  // ustaw panel (mobile: pod przyciskiem, desktop: pod akcjami)
  placeCompWrap();

  // pokaÅ¼ panel i przygotuj UI
  compartmentsOuter.style.display = '';   // w HTML startowo masz display:none
  actionsWrap.style.display = 'flex';
  expandAllBtn.disabled = true;
  sendShortagesBtn.disabled = true;
  compartmentsBox.innerHTML = '';
  compartmentsOuter.dataset.openFor = table; // zapamiÄ™taj otwarty wÃ³z

  // skeletony + pobranie skrytek
  showLoadingCompartments();
  try{
    const list = await fetchCompartmentsInTableOrder(currentTable);
    renderCompartments(list);
  }catch(err){
    compartmentsBox.innerHTML = `<div class="sub">BÅ‚Ä…d pobierania skrytek: ${err.message||err}</div>`;
  }
});


  // Klik w skrytkÄ™ / sprzÄ™t (delegacja na staÅ‚ym kontenerze)
  compartmentsBox?.addEventListener('click', (e)=>{
    const btn=e.target.closest('.compartment-btn'); if(btn) return openCompartment(btn);
    const row=e.target.closest('.equip-row'); if(!row) return;
    const k=keyFor(currentTable,row.dataset.compartment,row.dataset.id);
    row.classList.toggle('selected'); if(row.classList.contains('selected')) selectedSet.add(k); else selectedSet.delete(k);
  });

  // RozwiÅ„ wszystkie (dla bieÅ¼Ä…cego wozu) + â€ZwiÅ„ wszystkieâ€ na dole
  expandAllBtn?.addEventListener('click', async ()=>{
    if(!currentTable) return;
    const items=$$('#compartments .compartment-item');
    await Promise.all(items.map(async item=>{
      const b=item.querySelector('.compartment-btn'); const s=item.querySelector('.equip-slot');
      if(s.dataset.open==='true' && s.children.length) return;
      b.classList.add('primary'); s.dataset.open='true'; showLoadingEquipInSlot(s);
      try{ const rows=await fetchEquip(currentTable, b.getAttribute('data-compartment')); renderEquipInSlot(s, rows, currentTable, b.getAttribute('data-compartment')); }
      catch(err){ s.innerHTML=`<div class="sub">BÅ‚Ä…d pobierania sprzÄ™tu: ${err.message||err}</div>`; }
    }));
    if(!collapseAllBtn){
      collapseAllBtn=document.createElement('button'); collapseAllBtn.className='btn'; collapseAllBtn.textContent='ZwiÅ„ wszystkie'; collapseAllBtn.style.marginTop='12px'; collapseAllBtn.style.width='100%';
      collapseAllBtn.addEventListener('click',()=>{ $$('#compartments .equip-slot').forEach(s=>{ s.dataset.open='false'; s.innerHTML=''; }); $$('#compartments .compartment-btn').forEach(b=>b.classList.remove('primary')); collapseAllBtn.remove(); collapseAllBtn=null; });
      compartmentsBox.appendChild(collapseAllBtn);
    }
  });

  // WyÅ›lij Braki â€” tylko bieÅ¼Ä…cy wÃ³z
  document.getElementById('sendShortagesBtn')?.addEventListener('click', async ()=>{
    if(!currentVehicle || !currentTable) return;
    const selectedKeys=[...selectedSet].filter(k=>k.startsWith(currentTable+'|')); if(!selectedKeys.length){ alert('Nie wybrano Å¼adnych brakÃ³w.'); return; }
    const ids=[...new Set(selectedKeys.map(k=>Number(k.split('|')[2])).filter(Number.isFinite))];
    let equipById=new Map();
    try{ const { data, error } = await supabase.from(currentTable).select('id, "SPRZÄ˜T"').in('id',ids); if(error) throw error; (data||[]).forEach(r=>equipById.set(Number(r.id),(r['SPRZÄ˜T']??'').toString())); }
    catch(err){ showBanner('BÅ‚Ä…d pobierania danych sprzÄ™tu.','err',4000); return; }

    const { data: udata } = await supabase.auth.getUser(); const userId=udata?.user?.id||null;
    let shift=null, fullName=null; try{ const { data: prof } = await supabase.from('profiles').select('shift, full_name').eq('user_id',userId).maybeSingle(); shift=prof?.shift||null; fullName=prof?.full_name||null; }catch(e){}
    const rows=ids.map(id=>({ 'SPRZÄ˜T':equipById.get(id)||`ID ${id}`, 'WÃ“Z':currentVehicle, 'ZMIANA':shift, 'UÅ»YTKOWNIK':fullName, user_id:userId }));
    try{ const { error } = await supabase.from('shortages').insert(rows); if(error) throw error;
      showBanner(`WysÅ‚ano braki: ${rows.length} wiersz(y).`,'ok',4000);
      for(const k of [...selectedSet]) if(k.startsWith(currentTable+'|')) selectedSet.delete(k);
      $$('#compartments .equip-row.selected').forEach(r=>r.classList.remove('selected'));
    }catch(err){ showBanner('BÅ‚Ä…d zapisu brakÃ³w.','err',5000); }
  });

  /* ========= EKRAN BRAKI ========= */
  const fltDateFrom=$('#fltDateFrom'), fltDateTo=$('#fltDateTo'), fltVehicle=$('#fltVehicle'), fltUser=$('#fltUser');
  const btnSearch=$('#btnSearch'), tableBody=$('#shortagesTable tbody'), rowsInfo=$('#rowsInfo'), pageInfo=$('#pageInfo'), btnPrev=$('#btnPrev'), btnNext=$('#btnNext');
  let page=1; const pageSize=25; let lastRows=[];
  function buildQuery(){ let q=supabase.from('shortages').select('"SPRZÄ˜T","WÃ“Z","DATA","ZMIANA","UÅ»YTKOWNIK"',{count:'exact'}).order('DATA',{ascending:false});
    if(fltDateFrom.value){ q=q.gte('DATA',fltDateFrom.value+' 00:00'); } if(fltDateTo.value){ q=q.lte('DATA',fltDateTo.value+' 23:59'); }
    if(fltVehicle.value){ q=q.ilike('"WÃ“Z"',`%${fltVehicle.value}%`); } if(fltUser.value){ q=q.ilike('"UÅ»YTKOWNIK"',`%${fltUser.value}%`); }
    return q.range((page-1)*pageSize, page*pageSize-1);
  }
  async function loadShortages(){
    if(!document.body.contains(tableBody)) return;
    tableBody.innerHTML='<tr><td colspan="5">Åadowanieâ€¦</td></tr>';
    try{ const { data, count, error } = await buildQuery(); if(error) throw error; lastRows=data||[]; renderShortagesTable(lastRows); rowsInfo.textContent=`WynikÃ³w: ${count ?? lastRows.length}`; pageInfo.textContent=`Strona ${page}`; btnPrev.disabled=page<=1; btnNext.disabled=(count ?? lastRows.length) <= page*pageSize; }
    catch(e){ tableBody.innerHTML='<tr><td colspan="5">BÅ‚Ä…d pobierania.</td></tr>'; }
  }
  function renderShortagesTable(rows){
    if(!rows.length){ tableBody.innerHTML='<tr><td colspan="5">Brak danych.</td></tr>'; return; }
    tableBody.innerHTML=''; rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td data-label="SPRZÄ˜T">${(r['SPRZÄ˜T']||'').toString()}</td>
      <td data-label="WÃ“Z">${(r['WÃ“Z']||'').toString()}</td><td data-label="DATA">${formatDate(r['DATA'])}</td>
      <td data-label="ZMIANA">${(r['ZMIANA']||'').toString()}</td><td data-label="UÅ»YTKOWNIK">${(r['UÅ»YTKOWNIK']||'').toString()}</td>`; tableBody.appendChild(tr); });
  }
  btnSearch?.addEventListener('click',()=>{ page=1; loadShortages(); });
  btnPrev?.addEventListener('click',()=>{ if(page>1){ page--; loadShortages(); } });
  btnNext?.addEventListener('click',()=>{ page++; loadShortages(); });

  // ====== MENU ======
  document.querySelector('a[href="#home"][data-nav]')?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(sectionHome); loadTodayTask(); });
  document.querySelector('a[href="#fleet"][data-nav]')?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(sectionFleet); });
  document.querySelector('a[href="#equip"][data-nav]')?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(sectionEquip); });
  document.querySelector('a[href="#knowledge"][data-nav]')?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(sectionKnowledge); });
  document.getElementById('startQuizBtn')?.addEventListener('click', (e) => {
  e.preventDefault();
  history.pushState({}, '', '#quiz'); // zmienia adres URL
  showOnly(document.getElementById('quiz')); // wyÅ›wietla tylko quiz
});


  document.querySelector('#menuShortagesLink[data-nav]')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const { data: me } = await supabase.auth.getUser();
    const canSee = await isViewer(me?.user?.id);
    if(!canSee){ showBanner('Brak uprawnieÅ„ do podglÄ…du brakÃ³w.','err',3500); return; }
    if(!$('#fltDateFrom').value && !$('#fltDateTo').value){ const d=new Date(); const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0'); $('#fltDateFrom').value=`${y}-${m}-${dd}`; $('#fltDateTo').value=`${y}-${m}-${dd}`; }
    showOnly(sectionShort); page=1; loadShortages();
  });

  // ===== HOME: dzisiejsze zadanie (Europe/Warsaw) =====
  const todayBox=document.getElementById('todayBox');
  function getWarsawDow(){ const now=new Date(); const warsaw=new Date(now.toLocaleString('en-US',{timeZone:'Europe/Warsaw'})); const day=warsaw.getDay(); return day===0?7:day; }
  async function loadTodayTask(){
    if(!todayBox) return; todayBox.innerHTML='<div class="skeleton" style="height:92px"></div>';
    const dow=getWarsawDow();
    try{ const { data, error } = await supabase.from('weekly_tasks').select('dow, day_name, tasks').eq('dow',dow).maybeSingle(); if(error) throw error; renderToday(data); }
    catch(e){ todayBox.innerHTML='<div class="sub">BÅ‚Ä…d pobierania zadania na dziÅ›.</div>'; }
  }
  function renderToday(row){ const name=row?.day_name||'DziÅ›'; const tasks=(row?.tasks||'').toString(); todayBox.innerHTML=`<div class="today-card"><h3>${name} â€” dziÅ›</h3><div class="tasks">${tasks||'Brak zadania na dziÅ›.'}</div></div>`; }
  (function scheduleMidnightRefresh(){ const now=new Date(); const warsawNow=new Date(now.toLocaleString('en-US',{timeZone:'Europe/Warsaw'})); const midnight=new Date(warsawNow); midnight.setHours(24,0,0,0); const ms=midnight-warsawNow; setTimeout(()=>{ loadTodayTask(); scheduleMidnightRefresh(); }, Math.max(1000,ms)); })();

  /* ===== SprzÄ™t JRG â€” wyszukiwarka ===== */
  const equipQueryInput=$('#equipQuery'), equipSearchBtn=$('#equipSearchBtn'), equipInfo=$('#equipInfo'), equipResultsBody=$('#equipResultsBody');
  const EQUIP_TABLES=['411_22','411_23','411_25','411_26','411_43','411_51','411_71','411_91','411_59','411_22_Tyl','411_23_Tyl'];
  async function searchEquipmentGlobal(term){
    const q=term.trim(); if(!q){ equipInfo.textContent='Wpisz nazwÄ™ sprzÄ™tu i kliknij â€Szukajâ€.'; equipResultsBody.innerHTML=''; return; }
    equipInfo.textContent='Szukamâ€¦'; equipResultsBody.innerHTML='<tr><td colspan="4">Åadowanieâ€¦</td></tr>';
    const results=[]; await Promise.all(EQUIP_TABLES.map(async tbl=>{ const { data, error } = await supabase.from(tbl).select('compartment, "SPRZÄ˜T","ILOÅšÄ†"').ilike('"SPRZÄ˜T"', `%${q}%`); if(!error && data&&data.length){ data.forEach(r=>results.push({ item:(r['SPRZÄ˜T']||'').toString(), vehicle:tableToVehicleName(tbl), compartment:(r.compartment||'').toString(), qty:(r['ILOÅšÄ†']||'').toString() })); } }));
    results.sort((a,b)=> (a.vehicle.localeCompare(b.vehicle)||a.compartment.localeCompare(b.compartment)||a.item.localeCompare(b.item)));
    if(!results.length){ equipInfo.textContent='Brak wynikÃ³w.'; equipResultsBody.innerHTML='<tr><td colspan="4">Brak wynikÃ³w.</td></tr>'; return; }
    equipInfo.textContent=`Znaleziono: ${results.length}`;
    equipResultsBody.innerHTML=results.map(r=>`<tr><td data-label="SPRZÄ˜T">${r.item}</td><td data-label="WÃ“Z">${r.vehicle}</td><td data-label="SKRYTKA">${r.compartment}</td><td data-label="ILOÅšÄ†">${r.qty}</td></tr>`).join('');
  }
  equipSearchBtn?.addEventListener('click',()=>searchEquipmentGlobal(equipQueryInput.value));
  equipQueryInput?.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); searchEquipmentGlobal(equipQueryInput.value); } });

const startQuizButton = document.getElementById('run-weekly-quiz');
  const quizContainer = document.getElementById('quiz-container');

  async function getCurrentUserProfile() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return null;

    const { data, error } = await supabase
      .from('profiles')
      .select('full_name')
      .eq('user_id', user.id)
      .single();
    
    if (error) return null;
    return { userId: user.id, fullName: data.full_name };
  }

  function getCurrentWeekStartDate() {
    const now = new Date();
    const day = now.getDay();
    const diff = now.getDate() - day + (day === 0 ? -6 : 1);
    const monday = new Date(now.setDate(diff));
    monday.setHours(0, 0, 0, 0);
    return monday.toISOString();
  }

  async function hasUserCompletedQuiz(userId) {
    const weekStart = getCurrentWeekStartDate();
    const { data, error } = await supabase
      .from('quiz_attempts')
      .select('*')
      .eq('user_id', userId)
      .eq('week_start', weekStart);

    return data && data.length > 0;
  }

  async function loadQuestions() {
    const { data, error } = await supabase
      .from('quiz_questions')
      .select('*')
      .eq('active', true);
    
    if (error || !data) return [];
    const shuffled = data.sort(() => 0.5 - Math.random());
    return shuffled.slice(0, 10);
  }

  function askQuestion(questionObj, index) {
    return new Promise((resolve) => {
      quizContainer.innerHTML = `
        <h3>Pytanie ${index + 1}/10</h3>
        <p>${questionObj.question}</p>
        <div class="quiz-options" style="display: flex; flex-direction: column; gap: 10px;">
  ${['a','b','c','d','e'].map(opt => `
    <button class="btn quiz-btn" data-answer="${opt}">
      ${opt.toUpperCase()}: ${questionObj[opt] || ''}
    </button>
  `).join('')}
</div>

        <p id="timer">25</p>
      `;

      let selected = null;
      const buttons = quizContainer.querySelectorAll('button[data-answer]');
      buttons.forEach(btn => {
  btn.addEventListener('click', () => {
    selected = btn.dataset.answer;
    clearInterval(timerInterval);

    buttons.forEach(b => {
      b.classList.add('disabled');
      if (b.dataset.answer === questionObj.correct) {
        b.classList.add('correct');
      } else if (b === btn) {
        b.classList.add('incorrect');
      }
    });

    setTimeout(() => resolve(selected), 1500); // poczekaj 1.5s zanim przejdziesz dalej
  });
});


      let timeLeft = 25;
      const timer = quizContainer.querySelector('#timer');
      const timerInterval = setInterval(() => {
        timeLeft--;
        timer.textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          resolve(null);
        }
      }, 1000);
    });
  }

  async function runQuiz(userId, fullName) {
    const questions = await loadQuestions();
    let score = 0;
    const total = questions.length;
    const startedAt = new Date();

    for (let i = 0; i < total; i++) {
      const answer = await askQuestion(questions[i], i);
      if (answer && answer === questions[i].correct) score++;
    }

    const finishedAt = new Date();
    const weekStart = getCurrentWeekStartDate();

    await supabase.from('quiz_attempts').insert({
      user_id: userId,
      started_at: startedAt.toISOString(),
      finished_at: finishedAt.toISOString(),
      score,
      total,
      week_start: weekStart
    });

    quizContainer.innerHTML = `
      <h2>TwÃ³j wynik: ${score}/${total}</h2>
      <p>DziÄ™kujemy za udziaÅ‚, ${fullName}!</p>
    `;
  }

  startQuizButton?.addEventListener('click', async () => {
    quizContainer.innerHTML = '<p>Åadowanie quizu...</p>';
    const user = await getCurrentUserProfile();
    if (!user) {
      quizContainer.innerHTML = '<p>Musisz byÄ‡ zalogowany, aby wziÄ…Ä‡ udziaÅ‚ w quizie.</p>';
      return;
    }

    const alreadyPlayed = await hasUserCompletedQuiz(user.userId);
    if (alreadyPlayed) {
      quizContainer.innerHTML = '<p>JuÅ¼ wziÄ…Å‚eÅ› udziaÅ‚ w quizie w tym tygodniu.</p>';
      return;
    }

    await runQuiz(user.userId, user.fullName);
  });

  async function loadRanking(type) {
  const container = document.getElementById('ranking-container');
  container.innerHTML = '<p>Åadowanie...</p>';

  const tableName = type === 'weekly' ? 'quiz_weekly_scores' : 'quiz_monthly_scores';

  const { data, error } = await supabase
    .from(tableName)
    .select('user_id, total_score, period_start')
    .order('total_score', { ascending: false });

  if (error) {
    container.innerHTML = '<p>BÅ‚Ä…d Å‚adowania rankingu.</p>';
    console.error(error);
    return;
  }

  const userIds = data.map(entry => entry.user_id);
  const { data: profiles } = await supabase
    .from('profiles')
    .select('user_id, full_name')
    .in('user_id', userIds);

  const profileMap = Object.fromEntries(
    profiles.map(p => [p.user_id, p.full_name])
  );

  const rows = data.map((entry, index) => `
    <tr>
      <td>${index + 1}</td>
      <td>${profileMap[entry.user_id] || entry.user_id}</td>
      <td>${entry.total_score}</td>
      <td>${entry.period_start.split('T')[0]}</td>
    </tr>
  `).join('');

  container.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Pozycja</th>
          <th>UÅ¼ytkownik</th>
          <th>Punkty</th>
          <th>Okres</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;
}


</script>
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const supabase = createClient(
    'https://edihhrnejcdfashksssj.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkaWhocm5lamNkZmFzaGtzc3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MzcyMzEsImV4cCI6MjA2OTMxMzIzMX0.ci5U5kcutKCKVePCu-S-CmsxKm7pup6Bjbralj1aF9Y'
  );

  const startQuizButton = document.getElementById('run-weekly-quiz');
  const quizContainer = document.getElementById('quiz-container');

  async function getCurrentUserProfile() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return null;

    const { data, error } = await supabase
      .from('profiles')
      .select('full_name')
      .eq('user_id', user.id)
      .single();
    
    if (error) return null;
    return { userId: user.id, fullName: data.full_name };
  }

  function getCurrentWeekStartDate() {
    const now = new Date();
    const day = now.getDay();
    const diff = now.getDate() - day + (day === 0 ? -6 : 1);
    const monday = new Date(now.setDate(diff));
    monday.setHours(0, 0, 0, 0);
    return monday.toISOString();
  }

  async function hasUserCompletedQuiz(userId) {
    const weekStart = getCurrentWeekStartDate();
    const { data, error } = await supabase
      .from('quiz_attempts')
      .select('*')
      .eq('user_id', userId)
      .eq('week_start', weekStart);

    return data && data.length > 0;
  }

  async function loadQuestions() {
    const { data, error } = await supabase
      .from('quiz_questions')
      .select('*')
      .eq('active', true);
    
    if (error || !data) return [];
    const shuffled = data.sort(() => 0.5 - Math.random());
    return shuffled.slice(0, 10);
  }

  function askQuestion(questionObj, index) {
    return new Promise((resolve) => {
      quizContainer.innerHTML = `
        <h3>Pytanie ${index + 1}/10</h3>
        <p>${questionObj.question}</p>
        <div>
          ${['a','b','c','d','e'].map(opt => `
            <button class="btn" data-answer="${opt}">
              ${opt.toUpperCase()}: ${questionObj[opt] || ''}
            </button>
          `).join('')}
        </div>
        <p id="timer">25</p>
      `;

      let selected = null;
      const buttons = quizContainer.querySelectorAll('button[data-answer]');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          selected = btn.dataset.answer;
          clearInterval(timerInterval);
          resolve(selected);
        });
      });

      let timeLeft = 25;
      const timer = quizContainer.querySelector('#timer');
      const timerInterval = setInterval(() => {
        timeLeft--;
        timer.textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          resolve(null);
        }
      }, 1000);
    });
  }

  async function runQuiz(userId, fullName) {
    const questions = await loadQuestions();
    let score = 0;
    const total = questions.length;
    const startedAt = new Date();

    for (let i = 0; i < total; i++) {
      const answer = await askQuestion(questions[i], i);
      if (answer && answer === questions[i].correct) score++;
    }

    const finishedAt = new Date();
    const weekStart = getCurrentWeekStartDate();

    await supabase.from('quiz_attempts').insert({
      user_id: userId,
      started_at: startedAt.toISOString(),
      finished_at: finishedAt.toISOString(),
      score,
      total,
      week_start: weekStart
    });

    quizContainer.innerHTML = `
      <h2>TwÃ³j wynik: ${score}/${total}</h2>
      <p>DziÄ™kujemy za udziaÅ‚, ${fullName}!</p>
    `;
  }

  startQuizButton?.addEventListener('click', async () => {
    quizContainer.innerHTML = '<p>Åadowanie quizu...</p>';
    const user = await getCurrentUserProfile();
    if (!user) {
      quizContainer.innerHTML = '<p>Musisz byÄ‡ zalogowany, aby wziÄ…Ä‡ udziaÅ‚ w quizie.</p>';
      return;
    }

    const alreadyPlayed = await hasUserCompletedQuiz(user.userId);
    if (alreadyPlayed) {
      quizContainer.innerHTML = '<p>JuÅ¼ wziÄ…Å‚eÅ› udziaÅ‚ w quizie w tym tygodniu.</p>';
      return;
    }

    await runQuiz(user.userId, user.fullName);
  });



const ritBtn = document.getElementById('ritBtn');
const ritSection = document.getElementById('ritSection');
const ritTableContainer = document.getElementById('ritTableContainer');

ritBtn?.addEventListener('click', () => {
  const isVisible = ritSection.style.display === 'block';
  ritSection.style.display = isVisible ? 'none' : 'block';
});


const toggleRitTableBtn = document.getElementById('toggleRitTable');


toggleRitTableBtn?.addEventListener('click', async () => {
  const isVisible = ritTableContainer.style.display === 'block';
  ritTableContainer.style.display = isVisible ? 'none' : 'block';

  if (!isVisible) {
    ritTableContainer.innerHTML = '<p>Åadowanie danych...</p>';
    const { data, error } = await supabase
      .from('torba_rit')
      .select('sprzet, ilosc');

    if (error) {
      ritTableContainer.innerHTML = '<p>BÅ‚Ä…d Å‚adowania danych.</p>';
      console.error(error);
      return;
    }

    const rows = data.map(item => `
      <tr>
        <td>${item.sprzet}</td>
        <td>${item.ilosc}</td>
      </tr>
    `).join('');

    ritTableContainer.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>SPRZÄ˜T</th>
            <th>ILOÅšÄ†</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    `;
  }
});




const helpSection = document.getElementById('helpSection');

helpRequestBtn?.addEventListener('click', () => {
  const isVisible = helpSection.style.display === 'block';
  helpSection.style.display = isVisible ? 'none' : 'block';
});


const helpRequestBtnAlt = document.getElementById('helpRequestBtnAlt');






const helpSectionAlt = document.getElementById('helpSectionAlt');

helpRequestBtnAlt?.addEventListener('click', () => {
  const isVisible = helpSectionAlt.style.display === 'block';
  helpSectionAlt.style.display = isVisible ? 'none' : 'block';
});


const toolsBtn = document.getElementById('pomiaroweBtn');
const toolsSection = document.getElementById('toolsSection');

toolsBtn?.addEventListener('click', () => {
  const isVisible = toolsSection.style.display === 'block';
  toolsSection.style.display = isVisible ? 'none' : 'block';
});

const msaBtn = document.getElementById('msaBtn');
const msaSection = document.getElementById('msaSection');

msaBtn?.addEventListener('click', () => {
  const isVisible = msaSection.style.display === 'block';
  msaSection.style.display = isVisible ? 'none' : 'block';
});


const deviceButtonsContainer = document.getElementById('deviceButtonsContainer');
const deviceSectionContainer = document.getElementById('deviceSectionContainer');

let activeDeviceId = null;

async function loadDevices() {
  const { data: devices, error } = await supabase.from('devices').select('*');
  if (error) {
    console.error('BÅ‚Ä…d Å‚adowania urzÄ…dzeÅ„:', error);
    return;
  }

  devices.forEach(device => {
    const button = document.createElement('button');
    button.textContent = device.device_name;
    button.className = 'device-button';
    button.addEventListener('click', () => toggleDeviceDetails(device));
    deviceButtonsContainer.appendChild(button);
  });
}

async function toggleDeviceDetails(device) {
  // Ukryj, jeÅ›li klikniÄ™to ponownie ten sam przyrzÄ…d
  if (activeDeviceId === device.id) {
    deviceSectionContainer.innerHTML = '';
    activeDeviceId = null;
    return;
  }

  activeDeviceId = device.id;

  const { data: sensors, error } = await supabase
    .from('device_sensors')
    .select('sensor, low_alarm, high_alarm')
    .eq('device_id', device.id);

  if (error) {
    console.error('BÅ‚Ä…d Å‚adowania sensorÃ³w:', error);
    return;
  }

  const content = `
  <div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">
    <img src="${device.image_url}" alt="${device.device_name}" style="max-width: 200px; border: 2px solid black; border-radius: 10px;">
    <div style="flex: 1; min-width: 300px;">
      <table>
        <thead><tr><th>Czujnik</th><th>Low Alarm</th><th>High Alarm</th></tr></thead>
        <tbody>
          ${sensors.map(row => `
            <tr>
              <td>${row.sensor}</td>
              <td>${row.low_alarm}</td>
              <td>${row.high_alarm}</td>
            </tr>`).join('')}
        </tbody>
      </table>
    </div>
  </div>`;


  deviceSectionContainer.innerHTML = `
  <div class="container">
    <h2>${device.device_name}</h2>
    ${content}
  </div>`;

}

loadDevices();




</script>

</body>
</html>



